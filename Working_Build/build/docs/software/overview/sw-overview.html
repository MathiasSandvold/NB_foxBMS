<!-- https://stackoverflow.com/a/53329712 -->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. Software Structure Overview &mdash; foxBMS 2 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4. Software Modules" href="../modules/modules.html" />
    <link rel="prev" title="2. Building the Application" href="../build/build.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> foxBMS 2
            <img src="../../_static/foxbms250px.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/releases.html">1. Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/changelog.html">2. Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/motivation.html">3. Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/safety/safety.html">4. Safety</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/license.html">5. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/team.html">6. Team</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/abbreviations-definitions.html">1. Abbreviations and Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/naming-conventions.html">2. Naming Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/bms-overview.html">3. The foxBMS 2 Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/use-case.html">4. Use Case</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/getting-started.html">1. Getting Started with foxBMS 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/repository-structure.html">2. Repository Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/software-installation.html">3. Software Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/workspace.html">4. Creating a Workspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/first-steps-on-hardware.html">5. First Steps on Hardware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../configuration/configuration.html">1. Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/build.html">2. Building the Application</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Software Structure Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/modules.html">4. Software Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unit-tests/unit-tests.html">5. Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build-process/build-process.html">6. Build Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build-environment/build-environment.html">7. Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/how-to.html">8. How-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linker-script/linker-script.html">9. Linker Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/architecture.html">10. Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/overview.html">11. API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/hardware.html">1. Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/design-resources.html">2. Design Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/connectors.html">3. Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/master.html">4. Master Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/slaves.html">5. Slaves Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/interfaces.html">6. Interfaces Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">System Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../system/system-introduction.html">1. System Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/system-voltage-and-current-monitoring.html">2. System Voltage And Current Monitoring</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/dbc.html">1. DBC File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/gui/gui.html">2. foxBMS 2 GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/waf-tools/waf-tools.html">3. Waf Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/debugger/debug-application.html">4. Debugging the Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/halcogen/halcogen.html">5. HALCoGen tool documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/static-analysis/axivion.html">6. Axivion Bauhaus Suite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developer-manual/preface.html">1. Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-manual/style-guide/style-guide.html">2. Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-manual/software-developer-manual.html">3. Software Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-manual/hardware-developer-manual.html">4. Hardware Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-manual/public-release-process.html">5. Public Release Process</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/acknowledgements.html">1. Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/indices-and-tables.html">2. Indices and Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/bibliography.html">3. Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">foxBMS 2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li><span class="section-number">3. </span>Software Structure Overview</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/software/overview/sw-overview.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <div class="section" id="software-structure-overview">
<span id="id1"></span><h1><span class="section-number">3. </span>Software Structure Overview<a class="headerlink" href="#software-structure-overview" title="Permalink to this headline"></a></h1>
<div class="section" id="startup">
<h2><span class="section-number">3.1. </span>Startup<a class="headerlink" href="#startup" title="Permalink to this headline"></a></h2>
<p>The startup code begins in the function <code class="docutils literal notranslate"><span class="pre">_c_int00()</span></code> in
<code class="docutils literal notranslate"><span class="pre">app/main/fstartup.c</span></code>.
After initialization of the main microcontroller registers, memory, system
clock and interrupts, the C function <code class="docutils literal notranslate"><span class="pre">main()</span></code> is called.
In <code class="docutils literal notranslate"><span class="pre">general/main.c</span></code>, interrupts are enabled and the initializations of the
microcontroller unit, peripherals and software modules are done (e.g.,
hardware modules like SPI and DMA).
The OS is then started.
The steps are indicated by the global variable <code class="docutils literal notranslate"><span class="pre">os_boot</span></code>.
At the end of the main function, the operating system resources (tasks, queues)
are configured in <code class="docutils literal notranslate"><span class="pre">OS_InitializeOperatingSystem()</span></code> (<code class="docutils literal notranslate"><span class="pre">src/app/task/os/os.c</span></code>)
and the scheduler is started.
All configured tasks (FreeRTOS threads) are then started depending on
their priority.
The successful activation of the tasks is indicated by
<code class="docutils literal notranslate"><span class="pre">os_boot</span> <span class="pre">=</span> <span class="pre">OS_RUNNING</span></code>.</p>
<p>The OS-scheduler first calls the highest priority task.
All other cyclic tasks are blocked in a while-loop until the initialization of
this task finishes.
At the beginning of the task, <code class="docutils literal notranslate"><span class="pre">FTSK_InitializeUserCodeEngine()</span></code> is called.
In this function, the database is initialized.
Once finished, this is indicated by <code class="docutils literal notranslate"><span class="pre">os_boot</span> <span class="pre">=</span> <span class="pre">OS_ENGINE_RUNNING</span></code>.
The function <code class="docutils literal notranslate"><span class="pre">FTSK_RunUserCodeEngine()</span></code> is then called, where the diagnostic
module and the database are managed.</p>
<p>Once <code class="docutils literal notranslate"><span class="pre">os_boot</span> <span class="pre">=</span> <span class="pre">OS_ENGINE_RUNNING</span></code>, the 1ms cyclic task is unblocked.
The function <code class="docutils literal notranslate"><span class="pre">FTSK_InitializeUserCodePreCyclicTasks()</span></code> is called once first.
This function is called when the OS and the database are running but before
the cyclic tasks run.
Once <code class="docutils literal notranslate"><span class="pre">FTSK_InitializeUserCodePreCyclicTasks()</span></code> has finished, all cyclic tasks
are unblocked from there while-loop and run periodically.</p>
</div>
<div class="section" id="operating-system">
<h2><span class="section-number">3.2. </span>Operating System<a class="headerlink" href="#operating-system" title="Permalink to this headline"></a></h2>
<p>A critical section must be entered with the function <code class="docutils literal notranslate"><span class="pre">OS_EnterTaskCritical()</span></code>
and exited with the function <code class="docutils literal notranslate"><span class="pre">OS_ExitTaskCritical()</span></code>.</p>
<p>The operating system configuration can be found in the file
<code class="docutils literal notranslate"><span class="pre">FreeRTOSConfig.h</span></code>.
A detailed explanation of the parameters configured in this file is given at
<a class="reference external" href="https://www.freertos.org/a00110.html">https://www.freertos.org/a00110.html</a>.
HALCoGen generates the FreeRTOS sources on the fly during the build
process.
However, foxBMS 2 ships its own FreeRTOS source tree (in
<code class="docutils literal notranslate"><span class="pre">src/os/freertos</span></code>), and therefore the FreeRTOS sources generated by the
code generator are not needed and consequently removed.
Only the CPU clock frequency configured with HALCoGen is extracted from the
generated FreeRTOS sources and written into
<code class="docutils literal notranslate"><span class="pre">config_cpu_clock_hz.h</span></code>, which is included in foxBMS 2’s own
<code class="docutils literal notranslate"><span class="pre">FreeRTOSConfig.h</span></code>.</p>
</div>
<div class="section" id="software-architecture">
<h2><span class="section-number">3.3. </span>Software Architecture<a class="headerlink" href="#software-architecture" title="Permalink to this headline"></a></h2>
<p>The database runs with the highest priority in the system and provides
asynchronous data exchange for the whole system.
<a class="reference internal" href="#database-data-exchange"><span class="std std-numref">Fig. 3.2</span></a> shows the data exchanges implemented via the
database.</p>
<blockquote>
<div><div class="figure align-center" id="database-data-exchange">
<a class="reference internal image-reference" href="../../_images/database.png"><img alt="Database data exchange" src="../../_images/database.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-number">Fig. 3.2 </span><span class="caption-text">Asynchronous data exchange with the foxBMS 2 database</span><a class="headerlink" href="#database-data-exchange" title="Permalink to this image"></a></p>
</div>
</div></blockquote>
<p><a class="reference internal" href="#foxbms-2-structure"><span class="std std-numref">Fig. 3.3</span></a> shows the main structure of foxBMS 2.</p>
<blockquote>
<div><div class="figure align-center" id="foxbms-2-structure">
<a class="reference internal image-reference" href="../../_images/engine.png"><img alt="|foxbms| structure" src="../../_images/engine.png" style="width: 100%;" /></a>
<p class="caption"><span class="caption-number">Fig. 3.3 </span><span class="caption-text">Main tasks in foxBMS 2</span><a class="headerlink" href="#foxbms-2-structure" title="Permalink to this image"></a></p>
</div>
</div></blockquote>
<p>The two key modules used are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SYS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BMS</span></code></p></li>
</ul>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">SYS</span></code> has a lower priority than the database and a higher priority than
<code class="docutils literal notranslate"><span class="pre">BMS</span></code>. Both modules are implemented as a state machine, with a trigger
function that implements the transition between the states. The trigger
functions of <code class="docutils literal notranslate"><span class="pre">SYS</span></code> and <code class="docutils literal notranslate"><span class="pre">BMS</span></code> are called in <code class="docutils literal notranslate"><span class="pre">FTSK_RunUserCodeCyclic10ms()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">SYS</span></code> controls the operating state of the system. It starts the other
state machines (e.g., <code class="docutils literal notranslate"><span class="pre">BMS</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">BMS</span></code> gathers info on the system via the database and takes decisions based
on this data. The BMS is driven via CAN. Requests are made via CAN to go
either in STANDBY mode (i.e. contactors are open) or in NORMAL mode (i.e.
contactors are closed). A safety feature is that these requests must be sent
periodically every 100ms. <code class="docutils literal notranslate"><span class="pre">BMS</span></code> retrieves the state requests received via
CAN from the database and analyses them. If the requests are not sent
correctly, this means that the controlling unit driving the BMS has a
problem and the correctness of the orders sent to the BMS may not be given
anymore. As a consequence, in this case <code class="docutils literal notranslate"><span class="pre">BMS</span></code> makes a call to <code class="docutils literal notranslate"><span class="pre">CONT</span></code>
to open the contactors. Currently, <code class="docutils literal notranslate"><span class="pre">BMS</span></code> checks the cell voltages, the cell
temperatures and the global battery current. If one of these physical
quantities violates the safe operating area, <code class="docutils literal notranslate"><span class="pre">BMS</span></code> makes the
corresponding call to <code class="docutils literal notranslate"><span class="pre">CONT</span></code> to open the contactors. <code class="docutils literal notranslate"><span class="pre">BMS</span></code> is
started via an initial state request made in <code class="docutils literal notranslate"><span class="pre">SYS</span></code>.</p>
<p>A watchdog instance is needed in case one of the aforementioned tasks hangs.
This watchdog is made by the System Monitor module which monitors all
important tasks (e.g., <code class="docutils literal notranslate"><span class="pre">Database</span></code>, <code class="docutils literal notranslate"><span class="pre">SYS</span></code>, <code class="docutils literal notranslate"><span class="pre">BMS</span></code>): if any of the
monitored tasks hangs, this will be detected.</p>
<p>A last barrier is present in case all the preceding measures fail: the
hardware watchdog timer. In case it is not triggered periodically, it resets
the system.</p>
</div>
<div class="section" id="diagnostic">
<h2><span class="section-number">3.4. </span>Diagnostic<a class="headerlink" href="#diagnostic" title="Permalink to this headline"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">DIAG</span></code> module is designed to report problems on the whole system. The
events that trigger the <code class="docutils literal notranslate"><span class="pre">DIAG</span></code> module have to be defined by the user. The
event handler <code class="docutils literal notranslate"><span class="pre">DIAG_Handler(...)</span></code> has to be called when the event is
detected. The way the system reacts to a <code class="docutils literal notranslate"><span class="pre">Diag</span></code> event is defined via a
callback function or by the caller according the return value.</p>
</div>
<div class="section" id="data-stored-in-the-database">
<h2><span class="section-number">3.5. </span>Data stored in the database<a class="headerlink" href="#data-stored-in-the-database" title="Permalink to this headline"></a></h2>
<p>The following data is stored in the database:</p>
<blockquote>
<div><ul class="simple">
<li><p>Cell voltages</p></li>
<li><p>Cell temperatures</p></li>
<li><p>SOX (Battery state, contains e.g., State-of-Charge)</p></li>
<li><p>Balancing control</p></li>
<li><p>Balancing feedback</p></li>
<li><p>Current sensor measurements (includes pack voltages at different points)</p></li>
<li><p>Hardware information</p></li>
<li><p>Last state request made to the BMS</p></li>
<li><p>Minimum, maximum and average values for voltages and temperatures</p></li>
<li><p>Measurement from isolation monitor</p></li>
<li><p>Interface to communicate via I2C with extra functionalities on slave
(e.g., EEPROM, port expander)</p></li>
<li><p>Result from open-wire check on slaves</p></li>
<li><p>Error state of the BMS (i.e. error flags, set to 0 or 1)</p></li>
<li><p>MSL, maximum safety limits</p></li>
<li><p>RSL, recommended safety limits</p></li>
<li><p>MOL, maximum operating limits</p></li>
<li><p>Calculated values for moving average</p></li>
<li><p>Contactor feedback</p></li>
<li><p>Interlock feedback</p></li>
<li><p>BMS state (e.g., standby, normal, charge, error)</p></li>
<li><p>Current limits calculated for State-of-Function</p></li>
<li><p>Voltages read on GPIOs of the slaves</p></li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
          </div>
<a href="https://github.com/foxBMS/foxbms-2">
    <img style="position: absolute; top: 0; right: 0; border: 0;"
        src="../../_static/forkme.png" alt="Fork me on GitHub">
</a>

          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../build/build.html" class="btn btn-neutral float-left" title="2. Building the Application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../modules/modules.html" class="btn btn-neutral float-right" title="4. Software Modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V. All rights reserved. See license section for further information.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>