<!-- https://stackoverflow.com/a/53329712 -->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8.2.3. How to Write State Machines &mdash; foxBMS 2 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.2.4. How to Use Generated Sources from HALCoGen" href="../../software/configuration/without-halcogen_how-to.html" />
    <link rel="prev" title="8.2.2. How to Implement a New Temperature Sensor Driver" href="../../software/modules/driver/ts/adding-a-new-ts_how-to.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> foxBMS 2
            <img src="../../_static/foxbms250px.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/releases.html">1. Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/changelog.html">2. Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/motivation.html">3. Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/safety/safety.html">4. Safety</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/license.html">5. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/team.html">6. Team</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/abbreviations-definitions.html">1. Abbreviations and Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/naming-conventions.html">2. Naming Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/bms-overview.html">3. The foxBMS 2 Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/use-case.html">4. Use Case</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/getting-started.html">1. Getting Started with foxBMS 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/repository-structure.html">2. Repository Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/software-installation.html">3. Software Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/workspace.html">4. Creating a Workspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/first-steps-on-hardware.html">5. First Steps on Hardware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../software/configuration/configuration.html">1. Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/build/build.html">2. Building the Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/overview/sw-overview.html">3. Software Structure Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/modules/modules.html">4. Software Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/unit-tests/unit-tests.html">5. Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/build-process/build-process.html">6. Build Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/build-environment/build-environment.html">7. Build Environment</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../software/how-to/how-to.html">8. How-to</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../software/modules/driver/can/can_how-to.html">8.1.1. How to Use the CAN Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/modules/engine/diag/diag_how-to.html">8.1.2. How to Use the Diagnosis Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/modules/engine/database/database_how-to.html">8.1.3. How to Use the Database Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/modules/task/ftask/ftask_how-to.html">8.1.4. How to Use the FTASK Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/modules/main/fassert_how-to.html">8.1.5. How to Use assertions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/modules/driver/afe/adding-a-new-ic_how-to.html">8.2.1. How to Implement an Analog Front-End Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/modules/driver/ts/adding-a-new-ts_how-to.html">8.2.2. How to Implement a New Temperature Sensor Driver</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.2.3. How to Write State Machines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/configuration/without-halcogen_how-to.html">8.2.4. How to Use Generated Sources from HALCoGen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/unit-tests/unit-tests_how-to.html">8.2.5. How to use unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/unit-tests/unit-tests_how-to.html#guidelines-for-the-unit-test-skeleton">8.2.6. Guidelines for the Unit Test Skeleton</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/unit-tests/unit-tests_how-to.html#result">8.2.7. Result</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/unit-tests/unit-tests_how-to.html#how-to-exclude-files-from-unit-tests">8.2.8. How to exclude files from unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/unit-tests/unit-tests_how-to.html#using-ceedling-directly">8.2.9. Using ceedling directly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/build-environment/build-environment_how-to.html">8.2.10. Changing and Extending the Build Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../software/build-process/library-project_how-to.html">8.2.11. How to Build A Library and Link it in a foxBMS 2 Project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../software/linker-script/linker-script.html">9. Linker Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/architecture/architecture.html">10. Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/api/overview.html">11. API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/hardware.html">1. Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/design-resources.html">2. Design Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/connectors.html">3. Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/master.html">4. Master Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/slaves.html">5. Slaves Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/interfaces.html">6. Interfaces Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">System Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../system/system-introduction.html">1. System Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/system-voltage-and-current-monitoring.html">2. System Voltage And Current Monitoring</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/dbc.html">1. DBC File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/gui/gui.html">2. foxBMS 2 GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/waf-tools/waf-tools.html">3. Waf Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/debugger/debug-application.html">4. Debugging the Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/halcogen/halcogen.html">5. HALCoGen tool documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/static-analysis/axivion.html">6. Axivion Bauhaus Suite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../preface.html">1. Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="style-guide.html">2. Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software-developer-manual.html">3. Software Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hardware-developer-manual.html">4. Hardware Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../public-release-process.html">5. Public Release Process</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/acknowledgements.html">1. Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/indices-and-tables.html">2. Indices and Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/bibliography.html">3. Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">foxBMS 2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../software/how-to/how-to.html"><span class="section-number">8. </span>How-to</a> &raquo;</li>
      <li><span class="section-number">8.2.3. </span>How to Write State Machines</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer-manual/style-guide/state-machines_how-to.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <div class="section" id="how-to-write-state-machines">
<span id="id1"></span><h1><span class="section-number">8.2.3. </span>How to Write State Machines<a class="headerlink" href="#how-to-write-state-machines" title="Permalink to this headline"></a></h1>
<p>This section demonstrates how state machines are implemented within the
foxBMS 2 project.
A simple, but fully functional, real-world implementation of this can be found
in the debug AFE driver (see <a class="reference internal" href="../../software/modules/driver/afe/debug/default.html#debug-default"><span class="std std-ref">Debug Default</span></a>).</p>
<div class="section" id="the-example">
<h2><span class="section-number">8.2.3.1. </span>The Example<a class="headerlink" href="#the-example" title="Permalink to this headline"></a></h2>
<p>This example implements a simple state machine with the following states:</p>
<ul class="simple">
<li><p><strong>Uninitialized</strong></p></li>
<li><p><strong>Initialization</strong></p></li>
<li><p><strong>Running</strong></p></li>
<li><p><strong>Error</strong></p></li>
</ul>
<p>An error in this example is an unrecoverable error. This gives the
state flow diagram in <a class="reference internal" href="#state-diagram"><span class="std std-numref">Fig. 8.1</span></a>.</p>
<div class="figure align-default" id="state-diagram">
<div class="graphviz"><img src="../../_images/graphviz-d2a23cb645f1a48f65a9c5f4c87364d9597652de.png" alt="# Copyright (c) 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V.
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.
#
# 3. Neither the name of the copyright holder nor the names of its
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# We kindly request you to use one or more of the following phrases to refer to
# foxBMS in your hardware, software, documentation or advertising materials:
#
# - &quot;This product uses parts of foxBMS®&quot;
# - &quot;This product includes parts of foxBMS®&quot;
# - &quot;This product is derived from foxBMS®&quot;

digraph fsm_states {
    rankdir=LR;
    size=&quot;8,5&quot;
    node [shape = doublecircle] nd_uninitialized nd_error;
    node [shape = circle] nd_initialization nd_running;

    nd_uninitialized        [label=&lt;&lt;B&gt;Uninitialized&lt;/B&gt;&gt;];
    nd_error                [label=&lt;&lt;B&gt;Error&lt;/B&gt;&gt;];
    nd_initialization       [label=&lt;&lt;B&gt;Initialization&lt;/B&gt;&gt;];
    nd_running              [label=&lt;&lt;B&gt;Running&lt;/B&gt;&gt;];

    nd_uninitialized -&gt;nd_initialization    [label = &quot;Initialize&quot;];
    nd_initialization -&gt; nd_running         [label = &quot;&quot;];
    nd_running -&gt; nd_error                  [label = &quot;Runtime error&quot;];
    nd_running -&gt; nd_running                [label = &quot;Operational mode&quot;];
    nd_initialization -&gt; nd_error           [label = &quot;Initialization error&quot;];
}" class="graphviz" /></div>
<p class="caption"><span class="caption-number">Fig. 8.1 </span><span class="caption-text">States and their transitions</span><a class="headerlink" href="#state-diagram" title="Permalink to this image"></a></p>
</div>
<p>The state <strong>Initialization</strong> consists of three substates, which are
processed sequentially:</p>
<ul class="simple">
<li><p><strong>I</strong><sub>0</sub>: The first initialization substate</p></li>
<li><p><strong>I</strong><sub>1</sub>: The second initialization substates</p></li>
<li><p><strong>I</strong><sub>exit</sub>: The last initialization substate (e.g., for
some cleanup)</p></li>
</ul>
<p>The state <strong>Running</strong> consists of three substate which are run in an
endless loop in the following order:</p>
<ul class="simple">
<li><p><strong>R</strong><sub>0</sub>: The first running substate</p></li>
<li><p><strong>R</strong><sub>1</sub>: The second running substate</p></li>
<li><p><strong>R</strong><sub>2</sub>: The third running substate</p></li>
</ul>
<p>In any of the states  <strong>Initialization</strong> and <strong>Running</strong> and any of the
substates errors can occur. If this is the case, the state machine transitions
from the substate to the state <strong>Error</strong>. The full state machine graph is
shown in <a class="reference internal" href="#complete-state-diagram"><span class="std std-numref">Fig. 8.2</span></a> and in a simplified way in
<a class="reference internal" href="#complete-state-diagram-simplified"><span class="std std-numref">Fig. 8.3</span></a>:</p>
<div class="figure align-default" id="complete-state-diagram">
<div class="graphviz"><img src="../../_images/graphviz-a418a1ff00ca7a11a2140abeb0cb4bcc7ee7f8dc.png" alt="# Copyright (c) 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V.
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.
#
# 3. Neither the name of the copyright holder nor the names of its
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# We kindly request you to use one or more of the following phrases to refer to
# foxBMS in your hardware, software, documentation or advertising materials:
#
# - &quot;This product uses parts of foxBMS®&quot;
# - &quot;This product includes parts of foxBMS®&quot;
# - &quot;This product is derived from foxBMS®&quot;

digraph fsm_complete {
    rankdir=LR;
    size=&quot;8,5&quot;
    node [shape = doublecircle]     nd_uninitialized
                                    nd_error;
    node [shape = circle]           nd_initialization_0
                                    nd_initialization_1
                                    nd_initialization_exit
                                    nd_running_0
                                    nd_running_1
                                    nd_running_2;

    nd_uninitialized        [label=&lt;&lt;B&gt;Uninitialized&lt;/B&gt;&gt;];
    nd_initialization_0     [label=&lt;&lt;B&gt;I&lt;/B&gt;&lt;SUB&gt;0&lt;/SUB&gt;&gt;];
    nd_initialization_1     [label=&lt;&lt;B&gt;I&lt;/B&gt;&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    nd_initialization_exit  [label=&lt;&lt;B&gt;I&lt;/B&gt;&lt;SUB&gt;exit&lt;/SUB&gt;&gt;];
    nd_running_0            [label=&lt;&lt;B&gt;R&lt;/B&gt;&lt;SUB&gt;0&lt;/SUB&gt;&gt;];
    nd_running_1            [label=&lt;&lt;B&gt;R&lt;/B&gt;&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    nd_running_2            [label=&lt;&lt;B&gt;R&lt;/B&gt;&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    nd_error                [label=&lt;&lt;B&gt;Error&lt;/B&gt;&gt;];

    nd_uninitialized -&gt; nd_initialization_0
    nd_initialization_0 -&gt; nd_initialization_1
    nd_initialization_1 -&gt; nd_initialization_exit
    nd_initialization_exit -&gt; nd_running_0
    nd_running_0 -&gt; nd_running_1
    nd_running_1 -&gt; nd_running_2
    nd_running_2 -&gt; nd_running_0

    nd_initialization_0 -&gt; nd_error
    nd_initialization_1 -&gt; nd_error
    nd_initialization_exit -&gt; nd_error
    nd_running_0 -&gt; nd_error
    nd_running_1 -&gt; nd_error
    nd_running_2 -&gt; nd_error

}" class="graphviz" /></div>
<p class="caption"><span class="caption-number">Fig. 8.2 </span><span class="caption-text">States and substates and their transitions</span><a class="headerlink" href="#complete-state-diagram" title="Permalink to this image"></a></p>
</div>
<div class="figure align-default" id="complete-state-diagram-simplified">
<div class="graphviz"><img src="../../_images/graphviz-5789c7240ecaf1f9ab53acac727f4fe631de48b7.png" alt="# Copyright (c) 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V.
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.
#
# 3. Neither the name of the copyright holder nor the names of its
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# We kindly request you to use one or more of the following phrases to refer to
# foxBMS in your hardware, software, documentation or advertising materials:
#
# - &quot;This product uses parts of foxBMS®&quot;
# - &quot;This product includes parts of foxBMS®&quot;
# - &quot;This product is derived from foxBMS®&quot;

digraph fsm_complete_simple {
    rankdir=LR;
    size=&quot;8,5&quot;
    compound=true;
    node [shape = doublecircle]     nd_uninitialized
                                    nd_error;
    node [shape = circle]           nd_initialization_0
                                    nd_initialization_1
                                    nd_initialization_exit
                                    nd_running_0
                                    nd_running_1
                                    nd_running_2;

    nd_uninitialized                [label=&lt;&lt;B&gt;Uninitialized&lt;/B&gt;&gt;];
    nd_error                        [label=&lt;&lt;B&gt;Error&lt;/B&gt;&gt;];

    subgraph cluster_initialization {
        label = &lt;&lt;B&gt;Initialization&lt;/B&gt;&gt;;
        nd_initialization_0            [label=&lt;&lt;B&gt;I&lt;/B&gt;&lt;SUB&gt;0&lt;/SUB&gt;&gt;];
        nd_initialization_1            [label=&lt;&lt;B&gt;I&lt;/B&gt;&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
        nd_initialization_exit         [label=&lt;&lt;B&gt;I&lt;/B&gt;&lt;SUB&gt;exit&lt;/SUB&gt;&gt;];
    }

    subgraph cluster_running {
        label = &lt;&lt;B&gt;Running&lt;/B&gt;&gt;;
        nd_running_0                   [label=&lt;&lt;B&gt;R&lt;/B&gt;&lt;SUB&gt;0&lt;/SUB&gt;&gt;];
        nd_running_1                   [label=&lt;&lt;B&gt;R&lt;/B&gt;&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
        nd_running_2                   [label=&lt;&lt;B&gt;R&lt;/B&gt;&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    }

    nd_initialization_1 -&gt; nd_error [ltail=cluster_initialization];
    nd_running_1 -&gt; nd_error [ltail=cluster_running];
    nd_uninitialized -&gt; nd_initialization_0
    nd_initialization_0 -&gt; nd_initialization_1
    nd_initialization_1 -&gt; nd_initialization_exit
    nd_initialization_exit -&gt; nd_running_0
    nd_running_0 -&gt; nd_running_1
    nd_running_1 -&gt; nd_running_2
    nd_running_2 -&gt; nd_running_0
}" class="graphviz" /></div>
<p class="caption"><span class="caption-number">Fig. 8.3 </span><span class="caption-text">States and substates and their transitions in a simplified graph</span><a class="headerlink" href="#complete-state-diagram-simplified" title="Permalink to this image"></a></p>
</div>
</div>
<div class="section" id="implementing-the-state-machine">
<h2><span class="section-number">8.2.3.2. </span>Implementing the State Machine<a class="headerlink" href="#implementing-the-state-machine" title="Permalink to this headline"></a></h2>
<p>The following describes the idea behind the state machine pattern and how it
is implemented for the described example.</p>
<p>This how to is written in a top-down approach, starting for an abstract state
machine interface to more detailed implementations of subfunctions. This makes
the global understanding simpler. But this also means, that functions are used
and only explained at a later point in the text.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example, the module prefix will be <code class="docutils literal notranslate"><span class="pre">EG</span></code>. Sometimes in this how to
it will a appropriate to use a variable reference for the module prefix.
In that case <code class="docutils literal notranslate"><span class="pre">{MODULE_PREFIX}</span></code> is used.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In running text functions always use parentheses with no argument or three
dots (<code class="docutils literal notranslate"><span class="pre">...</span></code>) to indicate that a function is referred to. Code examples of
course always implement the full and correct function or function call.
Below two simple examples are shown:</p>
<ul class="simple">
<li><p>The function <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">noArguments()</span></code> is referred to by <code class="docutils literal notranslate"><span class="pre">noArguments()</span></code>.</p></li>
<li><p>The function <code class="docutils literal notranslate"><span class="pre">uint8_t</span> <span class="pre">addTwoNumbers(uint8_t</span> <span class="pre">a,</span> <span class="pre">uint8_t</span> <span class="pre">b)</span></code> is
referred to by <code class="docutils literal notranslate"><span class="pre">addTwoNumbers()</span></code>.</p></li>
</ul>
</div>
<div class="section" id="basics">
<span id="implementation-basics"></span><h3><span class="section-number">8.2.3.2.1. </span>Basics<a class="headerlink" href="#basics" title="Permalink to this headline"></a></h3>
<p>All states <strong>MUST</strong> be put into an enum describing the states. There are four
states in the example (<strong>Uninitialized</strong>, <strong>Initialization</strong>,
<strong>Running</strong>, <strong>Error</strong>) plus the boilerplate of the state machine (a
dummy state called <code class="docutils literal notranslate"><span class="pre">Dummy</span></code> and a state indicating that the state machine has
never run called <code class="docutils literal notranslate"><span class="pre">Has_never_run</span></code>). The enum entries <strong>MUST</strong> use
<code class="docutils literal notranslate"><span class="pre">FSM_STATE</span></code> as infix after the module prefix. Taking all these rules into
account, the enum for the states used in this example looks like this:</p>
<div class="literal-block-wrapper docutils container" id="enum-for-states">
<div class="code-block-caption"><span class="caption-number">Listing 8.19 </span><span class="caption-text">Enumeration of the states</span><a class="headerlink" href="#enum-for-states" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">2</span><span class="w">     </span><span class="n">EG_FSM_STATE_DUMMY</span><span class="p">,</span><span class="w">          </span><span class="cm">/*!&lt; dummy state - always the first state */</span><span class="w"></span>
<span class="linenos">3</span><span class="w">     </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w">  </span><span class="cm">/*!&lt; never run state - always the second state */</span><span class="w"></span>
<span class="linenos">4</span><span class="w">     </span><span class="n">EG_FSM_STATE_UNINITIALIZED</span><span class="p">,</span><span class="w">  </span><span class="cm">/*!&lt; uninitialized state */</span><span class="w"></span>
<span class="linenos">5</span><span class="w">     </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">,</span><span class="w"> </span><span class="cm">/*!&lt; initializing the state machine */</span><span class="w"></span>
<span class="linenos">6</span><span class="w">     </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">,</span><span class="w">        </span><span class="cm">/*!&lt; operational mode of the state machine  */</span><span class="w"></span>
<span class="linenos">7</span><span class="w">     </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">,</span><span class="w">          </span><span class="cm">/*!&lt; state for error processing  */</span><span class="w"></span>
<span class="linenos">8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>A similar pattern has to be applied for the substates. For the boilerplate, a
dummy substate called <code class="docutils literal notranslate"><span class="pre">Dummy</span></code> (as in the state) and an additional substate
called <code class="docutils literal notranslate"><span class="pre">Entry</span></code>  have to be defined. The enum entries <strong>MUST</strong> use
<code class="docutils literal notranslate"><span class="pre">FSM_SUBSTATE</span></code> as infix after the module prefix. Taking all these rules into
account, the enum for the substates used in this example looks like this:</p>
<div class="literal-block-wrapper docutils container" id="substates">
<div class="code-block-caption"><span class="caption-number">Listing 8.20 </span><span class="caption-text">Enumeration of the substates</span><a class="headerlink" href="#substates" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w">               </span><span class="cm">/*!&lt; dummy state - always the first substate */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w">               </span><span class="cm">/*!&lt; entry state - always the second substate */</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_0</span><span class="p">,</span><span class="w">    </span><span class="cm">/*!&lt; fist initialization substate */</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_1</span><span class="p">,</span><span class="w">    </span><span class="cm">/*!&lt; second initialization substate */</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_EXIT</span><span class="p">,</span><span class="w"> </span><span class="cm">/*!&lt; last initialization substate */</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">,</span><span class="w">           </span><span class="cm">/*!&lt; fist running substate */</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_RUNNING_1</span><span class="p">,</span><span class="w">           </span><span class="cm">/*!&lt; second running substate */</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATE_RUNNING_2</span><span class="p">,</span><span class="w">           </span><span class="cm">/*!&lt; third running substate */</span><span class="w"></span>
<span class="linenos">10</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>A struct named <code class="docutils literal notranslate"><span class="pre">{MODULE_PREFIX}_STATE_s</span></code> contains the general state of the
state machine, with variables like <code class="docutils literal notranslate"><span class="pre">currentState</span></code> and <code class="docutils literal notranslate"><span class="pre">previousState</span></code>. In
this example this struct is named <code class="docutils literal notranslate"><span class="pre">EG_STATE_s</span></code>.
This struct is typically extended by an additional struct that holds relevant
information or data (<code class="docutils literal notranslate"><span class="pre">EG_INFORMATION_s</span> <span class="pre">information</span></code>). In a real application
these are usually pointers to some database entries required (see
<a class="reference internal" href="../../software/modules/driver/afe/debug/default.html#debug-default"><span class="std std-ref">Debug Default</span></a>) or variables used within the module. In this example it
is just a struct holding three values.</p>
<div class="literal-block-wrapper docutils container" id="state-type">
<div class="code-block-caption"><span class="caption-number">Listing 8.21 </span><span class="caption-text">The state type</span><a class="headerlink" href="#state-type" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w">                      </span><span class="cm">/*!&lt; timer of the state */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">triggerEntry</span><span class="p">;</span><span class="w">                </span><span class="cm">/*!&lt; trigger entry of the state */</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; next state of the FSM */</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">currentState</span><span class="p">;</span><span class="w">        </span><span class="cm">/*!&lt; current state of the FSM */</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">previousState</span><span class="p">;</span><span class="w">       </span><span class="cm">/*!&lt; previous state of the FSM */</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">;</span><span class="w">     </span><span class="cm">/*!&lt; next substate of the FSM */</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">currentSubstate</span><span class="p">;</span><span class="w">  </span><span class="cm">/*!&lt; current substate of the FSM */</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">     </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">previousSubstate</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; previous substate of the FSM */</span><span class="w"></span>
<span class="linenos">10</span><span class="w">     </span><span class="n">EG_INFORMATION_s</span><span class="w"> </span><span class="n">information</span><span class="p">;</span><span class="w">        </span><span class="cm">/*!&lt; Some information to be stored */</span><span class="w"></span>
<span class="linenos">11</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">EG_STATE_s</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>With these lines of code, all types needed for the state machine are defined.
The next step is the implementation of the state machine.</p>
<p>The first thing to do is to declare a variable for the state machine state</p>
<div class="literal-block-wrapper docutils container" id="introduction-of-state-variable">
<div class="code-block-caption"><span class="caption-number">Listing 8.22 </span><span class="caption-text">The state variable</span><a class="headerlink" href="#introduction-of-state-variable" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="n">eg_state</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>and initialize it as shown in <a class="reference internal" href="#initialization-of-state-variable"><span class="std std-numref">Listing 8.23</span></a>. The
members of the struct related to the state (<code class="docutils literal notranslate"><span class="pre">previousState</span></code>, <code class="docutils literal notranslate"><span class="pre">currentState</span></code>
and <code class="docutils literal notranslate"><span class="pre">nextState</span></code>) <strong>MUST</strong> be initialized with
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_HAS_NEVER_RUN</span></code> to indicate that the state machine has not run
yet. The members of the struct related to the substate (<code class="docutils literal notranslate"><span class="pre">previousSubstate</span></code>,
<code class="docutils literal notranslate"><span class="pre">currentSubstate</span></code> and <code class="docutils literal notranslate"><span class="pre">nextSubstate</span></code>) <strong>MUST</strong> be initialized with the
dummy state <code class="docutils literal notranslate"><span class="pre">EG_FSM_SUBSTATE_DUMMY</span></code>. The information struct can be anything
that is required by the application.</p>
<div class="literal-block-wrapper docutils container" id="initialization-of-state-variable">
<div class="code-block-caption"><span class="caption-number">Listing 8.23 </span><span class="caption-text">The state variable</span><a class="headerlink" href="#initialization-of-state-variable" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="n">eg_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="p">.</span><span class="n">timer</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="p">.</span><span class="n">triggerEntry</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="p">.</span><span class="n">nextState</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">     </span><span class="p">.</span><span class="n">currentState</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">     </span><span class="p">.</span><span class="n">previousState</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">     </span><span class="p">.</span><span class="n">nextSubstate</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">     </span><span class="p">.</span><span class="n">currentSubstate</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">     </span><span class="p">.</span><span class="n">previousSubstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w"></span>
<span class="linenos">10</span><span class="w">     </span><span class="p">.</span><span class="n">information</span><span class="p">.</span><span class="n">r0</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos">11</span><span class="w">     </span><span class="p">.</span><span class="n">information</span><span class="p">.</span><span class="n">r1</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos">12</span><span class="w">     </span><span class="p">.</span><span class="n">information</span><span class="p">.</span><span class="n">r2</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos">13</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>A state machine always consists of a periodic <em>trigger</em> function. The trigger
function gets the state variable introduced above (<code class="docutils literal notranslate"><span class="pre">eg_state</span></code> in this
example) as parameter. The trigger function <strong>MUST</strong> use <code class="docutils literal notranslate"><span class="pre">Trigger</span></code> as
function name infix. This example uses <code class="docutils literal notranslate"><span class="pre">EG_Trigger()</span></code>. If needed, the name
can be extended (e.g., <code class="docutils literal notranslate"><span class="pre">EG_TriggerAfe()</span></code>).</p>
<div class="literal-block-wrapper docutils container" id="introduction-of-trigger-function">
<div class="code-block-caption"><span class="caption-number">Listing 8.24 </span><span class="caption-text">The trigger function</span><a class="headerlink" href="#introduction-of-trigger-function" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="n">EG_Trigger</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>The trigger function is then called somewhere in the application with
<code class="docutils literal notranslate"><span class="pre">EG_Trigger(&amp;eg_state);</span></code></p>
<p>The trigger function is always implemented as shown in
<a class="reference internal" href="#implementation-of-trigger-function"><span class="std std-numref">Listing 8.25</span></a> where <code class="docutils literal notranslate"><span class="pre">EG_RunStateMachine()</span></code>
is the actual state machine implementation. The base name of the function
<strong>MUST</strong> be <code class="docutils literal notranslate"><span class="pre">{MODULE_PREFIX}_RunStateMachine</span></code>. The implementation of
<code class="docutils literal notranslate"><span class="pre">EG_CheckMultipleCalls()</span></code> can be taken directly from the
example code. The detailed explanation of this function is found later in the
text in <a class="reference internal" href="#function-check-reentrance"><span class="std std-numref">Section 8.2.3.3.1</span></a>.</p>
<p>It is often necessary to wait a definite amount of time. This can be the case
for example when the state machine waits for a measurement to be finished
before continuing. Waiting is implemented via the variable <code class="docutils literal notranslate"><span class="pre">timer</span></code> which
is a member of the state variable. It must be decremented one time every time
the trigger function is called. Two cases can happen:</p>
<blockquote>
<div><ul class="simple">
<li><p>If it has the value zero, it stays at zero and the content of the state
machine is processed further.</p></li>
<li><p>If is has a non-zero value, it is decremented and the trigger function
exits without processing the state machine.</p></li>
</ul>
</div></blockquote>
<p>To wait a definite amount of time, the <code class="docutils literal notranslate"><span class="pre">time</span></code> variable must only be assigned
a non-zero value. The time to wait will depend on the periodicity with which
the state machine is processed via the trigger function. If <code class="docutils literal notranslate"><span class="pre">timer</span></code> is set
to <code class="docutils literal notranslate"><span class="pre">N</span></code> and the trigger function is called with a period <code class="docutils literal notranslate"><span class="pre">T</span></code>, the wait time
before the state machine is processed further will be <code class="docutils literal notranslate"><span class="pre">N*T</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="implementation-of-trigger-function">
<div class="code-block-caption"><span class="caption-number">Listing 8.25 </span><span class="caption-text">Implementation of the trigger function</span><a class="headerlink" href="#implementation-of-trigger-function" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="nf">EG_Trigger</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">pEgState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL_PTR</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="n">earlyExit</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="w">     </span><span class="cm">/* Check re-entrance of function */</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_MULTIPLE_CALLS_YES</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_CheckMultipleCalls</span><span class="p">(</span><span class="n">pEgState</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">         </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_NOT_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">         </span><span class="n">earlyExit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">earlyExit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">timer</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0u</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">--</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0u</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">15</span><span class="w">                 </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">triggerEntry</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">                 </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span><span class="w">                 </span><span class="n">earlyExit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">18</span><span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="linenos">19</span><span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="linenos">20</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">earlyExit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">23</span><span class="w">         </span><span class="n">EG_RunStateMachine</span><span class="p">(</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">24</span><span class="w">         </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">triggerEntry</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">26</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">returnValue</span><span class="p">;</span><span class="w"></span>
<span class="linenos">27</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>As stated above the actual state machine is processed by
<code class="docutils literal notranslate"><span class="pre">EG_RunStateMachine()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">EG_RunStateMachine()</span></code> must process all states,
<strong>except for the dummy state</strong> (<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code>). A condensed version of
the state machine runner function looks like this:</p>
<div class="literal-block-wrapper docutils container" id="condensed-state-machine-runner-function">
<div class="code-block-caption"><span class="caption-number">Listing 8.26 </span><span class="caption-text">Condensed state machine runner function</span><a class="headerlink" href="#condensed-state-machine-runner-function" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="nf">EG_RunStateMachine</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="n">ranStateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_DUMMY</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">         </span><span class="cm">/********************************************** STATE: HAS NEVER RUN */</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">:</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">             </span><span class="cm">/* code goes here */</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">         </span><span class="cm">/********************************************** STATE: UNINITIALIZED */</span><span class="w"></span>
<span class="linenos">11</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_UNINITIALIZED</span><span class="p">:</span><span class="w"></span>
<span class="linenos">12</span><span class="w">             </span><span class="cm">/* code goes here */</span><span class="w"></span>
<span class="linenos">13</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">         </span><span class="cm">/********************************************* STATE: INITIALIZATION */</span><span class="w"></span>
<span class="linenos">16</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_INITIALIZATION</span><span class="p">:</span><span class="w"></span>
<span class="linenos">17</span><span class="w">             </span><span class="cm">/* code goes here */</span><span class="w"></span>
<span class="linenos">18</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">         </span><span class="cm">/**************************************************** STATE: RUNNING */</span><span class="w"></span>
<span class="linenos">21</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_RUNNING</span><span class="p">:</span><span class="w"></span>
<span class="linenos">22</span><span class="w">             </span><span class="cm">/* code goes here */</span><span class="w"></span>
<span class="linenos">23</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">         </span><span class="cm">/****************************************************** STATE: ERROR */</span><span class="w"></span>
<span class="linenos">25</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_ERROR</span><span class="p">:</span><span class="w"></span>
<span class="linenos">26</span><span class="w">             </span><span class="cm">/* code goes here */</span><span class="w"></span>
<span class="linenos">27</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">         </span><span class="cm">/**************************************************** STATE: DEFAULT */</span><span class="w"></span>
<span class="linenos">30</span><span class="w">         </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="linenos">31</span><span class="w">             </span><span class="cm">/* all cases must be processed, trap if unknown state arrives */</span><span class="w"></span>
<span class="linenos">32</span><span class="w">             </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"></span>
<span class="linenos">33</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">ranStateMachine</span><span class="p">;</span><span class="w"></span>
<span class="linenos">37</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>It can now be seen why the <code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code> state must never be processed
by the state machine: If a function irregularly sets the state to
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code>, the state machine will switch to the default case and
the <code class="docutils literal notranslate"><span class="pre">FAS_ASSERT()</span></code> function will stop this undefined behavior.</p>
</div>
<div class="section" id="description-of-the-implementation-of-all-cases">
<h3><span class="section-number">8.2.3.2.2. </span>Description of the Implementation of All Cases<a class="headerlink" href="#description-of-the-implementation-of-all-cases" title="Permalink to this headline"></a></h3>
<p>At next the implementations of all cases are explained in detail.</p>
<div class="section" id="eg-fsm-state-has-never-run">
<h4><span class="section-number">8.2.3.2.2.1. </span><code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_HAS_NEVER_RUN</span></code><a class="headerlink" href="#eg-fsm-state-has-never-run" title="Permalink to this headline"></a></h4>
<p>If the state machine has never run, it needs to be transferred to known state,
the uninitialized state (<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_UNINITIALIZED</span></code>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section uses the function <code class="docutils literal notranslate"><span class="pre">EG_SetState()</span></code>. The detailed
explanation of <code class="docutils literal notranslate"><span class="pre">EG_SetState()</span></code> is found later in the text in
<a class="reference internal" href="#function-set-state"><span class="std std-numref">Section 8.2.3.3.2</span></a>.</p>
</div>
<div class="literal-block-wrapper docutils container" id="never-to-uninitialized">
<div class="code-block-caption"><span class="caption-number">Listing 8.27 </span><span class="caption-text">Transition from the first startup of the state machine</span><a class="headerlink" href="#never-to-uninitialized" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">2</span><span class="w">     </span><span class="cm">/********************************************** STATE: HAS NEVER RUN */</span><span class="w"></span>
<span class="linenos">3</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">:</span><span class="w"></span>
<span class="linenos">4</span><span class="w">         </span><span class="cm">/* Nothing to do, just transfer */</span><span class="w"></span>
<span class="linenos">5</span><span class="w">         </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_UNINITIALIZED</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">6</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">7</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">8</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="eg-fsm-state-uninitialized">
<h4><span class="section-number">8.2.3.2.2.2. </span><code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_UNINITIALIZED</span></code><a class="headerlink" href="#eg-fsm-state-uninitialized" title="Permalink to this headline"></a></h4>
<p>This is the first state that is present in the state machine example. In
the example there is nothing to do in the state <strong>Uninitialized</strong>. For most
applications this will also be the case. However, if needed an application can
implement some behavior in this state before transferring to the state
<strong>Initialization</strong> (<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_INITIALIZATION</span></code>):</p>
<div class="literal-block-wrapper docutils container" id="uninitialized-to-initialization">
<div class="code-block-caption"><span class="caption-number">Listing 8.28 </span><span class="caption-text">Transition from the first startup of the state machine</span><a class="headerlink" href="#uninitialized-to-initialization" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">2</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">3</span><span class="w">     </span><span class="cm">/********************************************** STATE: UNINITIALIZED */</span><span class="w"></span>
<span class="linenos">4</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_UNINITIALIZED</span><span class="p">:</span><span class="w"></span>
<span class="linenos">5</span><span class="w">         </span><span class="cm">/* Nothing to do, just transfer */</span><span class="w"></span>
<span class="linenos">6</span><span class="w">         </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">7</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">8</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">9</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="eg-fsm-state-initialization">
<h4><span class="section-number">8.2.3.2.2.3. </span><code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_INITIALIZATION</span></code><a class="headerlink" href="#eg-fsm-state-initialization" title="Permalink to this headline"></a></h4>
<p>The example  showed, that the state <strong>Initialization</strong> consists of three
substates. Putting all code for all substates directly into the state
<strong>Initialization</strong> would cause bad readability and bad maintainability.
Therefore all details of what happens in the state are implemented
in state processing functions. <a class="reference internal" href="#state-processing-functions"><span class="std std-ref">Description of the Implementation of State Processing Functions</span></a> explains what
state processing functions are and how they work. For now it is sufficient to
know that state processing functions need to exist.</p>
<p>If an error occurs in any of the substates of the state <strong>Initialization</strong>
the state machine needs to transfer to the state <strong>Error</strong>. The transitions
based on the states and substates would not be clearly visible in such a
implementation.
Therefore this logic is transferred into a state processing function
<code class="docutils literal notranslate"><span class="pre">EG_ProcessInitializationState()</span></code>. State processing functions <strong>MUST</strong> use
the naming pattern <code class="docutils literal notranslate"><span class="pre">{MODULE_PREFIX}_Process{StateName}State</span></code> where
<code class="docutils literal notranslate"><span class="pre">{StateName}</span></code> is the state to be processed, e.g., for the
state <strong>Initialization</strong> <code class="docutils literal notranslate"><span class="pre">{StateName}</span></code> needs to be replaced by
<code class="docutils literal notranslate"><span class="pre">Initialization</span></code>.</p>
<p>The state processing function (in this example
<code class="docutils literal notranslate"><span class="pre">EG_ProcessInitializationState()</span></code>) returns the state the state machine has
to transition to.</p>
<p>Generally three cases can happen:</p>
<ul class="simple">
<li><p>the state machine stays in the current state,</p></li>
<li><p>the state machine transitions to another state or</p></li>
<li><p>something went wrong and the state machine must process the error.</p></li>
</ul>
<p>To reflect this, an <code class="docutils literal notranslate"><span class="pre">if-else</span></code> structure is used. The first <code class="docutils literal notranslate"><span class="pre">if</span></code> always
processes the current case, i.e. staying in the current state. The final
<code class="docutils literal notranslate"><span class="pre">else</span></code> always processes the case if something unforeseen went wrong and
performs an assertion. Between the <code class="docutils literal notranslate"><span class="pre">if</span></code> and <code class="docutils literal notranslate"><span class="pre">else</span></code> all <code class="docutils literal notranslate"><span class="pre">else</span> <span class="pre">if</span></code>
implement the state transitions to other states. For this example this
translates into the following code:</p>
<div class="literal-block-wrapper docutils container" id="the-initialization-state">
<div class="code-block-caption"><span class="caption-number">Listing 8.29 </span><span class="caption-text">The initialization state is processed by an own function</span><a class="headerlink" href="#the-initialization-state" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="cm">/********************************************* STATE: INITIALIZATION */</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_INITIALIZATION</span><span class="p">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">         </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">             </span><span class="cm">/* staying in state, processed by substate function */</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">             </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">10</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">             </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">             </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Something went wrong */</span><span class="w"></span>
<span class="linenos">14</span><span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">16</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">17</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="eg-fsm-state-running">
<h4><span class="section-number">8.2.3.2.2.4. </span><code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_RUNNING</span></code><a class="headerlink" href="#eg-fsm-state-running" title="Permalink to this headline"></a></h4>
<p>After a successful initialization the state machine transfers into the
operational mode. As described above, the state machine stays in that state
until an error occurs. This state is also processed by the state function
<code class="docutils literal notranslate"><span class="pre">EG_ProcessRunningState()</span></code> as it has more than one option to transfer to
(either staying in the state or going to an error state).</p>
<div class="literal-block-wrapper docutils container" id="the-running-state">
<div class="code-block-caption"><span class="caption-number">Listing 8.30 </span><span class="caption-text">The running state is also processed by a own function</span><a class="headerlink" href="#the-running-state" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="cm">/**************************************************** STATE: RUNNING */</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_RUNNING</span><span class="p">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">         </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_ProcessRunningState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">             </span><span class="cm">/* staying in state, processed by state function */</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">             </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">10</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">             </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Something went wrong */</span><span class="w"></span>
<span class="linenos">12</span><span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">15</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="eg-fsm-state-error">
<h4><span class="section-number">8.2.3.2.2.5. </span><code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_ERROR</span></code><a class="headerlink" href="#eg-fsm-state-error" title="Permalink to this headline"></a></h4>
<p>This state processes the error case. Errors can be recoverable, but in this
example, for the sake of simplicity, they are not.</p>
<div class="literal-block-wrapper docutils container" id="the-error-state">
<div class="code-block-caption"><span class="caption-number">Listing 8.31 </span><span class="caption-text">The error state</span><a class="headerlink" href="#the-error-state" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">2</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">3</span><span class="w">     </span><span class="cm">/****************************************************** STATE: ERROR */</span><span class="w"></span>
<span class="linenos">4</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_ERROR</span><span class="p">:</span><span class="w"></span>
<span class="linenos">5</span><span class="w">         </span><span class="cm">/* implement error processing here or trap */</span><span class="w"></span>
<span class="linenos">6</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">7</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">8</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>In many cases an error is recoverable. Such a situation is described in
<a class="reference internal" href="#recoverable-error"><span class="std std-ref">Extended Example With Recoverable Error</span></a></p>
</div>
<div class="section" id="default">
<span id="default-case"></span><h4><span class="section-number">8.2.3.2.2.6. </span><code class="docutils literal notranslate"><span class="pre">default</span></code><a class="headerlink" href="#default" title="Permalink to this headline"></a></h4>
<p>This case makes sure that all states are correctly processed and the dummy
state (<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code>) is not used. If this is not the case then
this function traps.</p>
<div class="literal-block-wrapper docutils container" id="the-default-state">
<div class="code-block-caption"><span class="caption-number">Listing 8.32 </span><span class="caption-text">The default state</span><a class="headerlink" href="#the-default-state" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">2</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">3</span><span class="w">     </span><span class="cm">/**************************************************** STATE: DEFAULT */</span><span class="w"></span>
<span class="linenos">4</span><span class="w">     </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="linenos">5</span><span class="w">         </span><span class="cm">/* all cases must be processed, trap if unknown state arrives */</span><span class="w"></span>
<span class="linenos">6</span><span class="w">         </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"></span>
<span class="linenos">7</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">8</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="eg-fsm-state-dummy">
<h4><span class="section-number">8.2.3.2.2.7. </span><code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code><a class="headerlink" href="#eg-fsm-state-dummy" title="Permalink to this headline"></a></h4>
<p>As already stated in <a class="reference internal" href="#default-case"><span class="std std-ref">default</span></a> processing the <code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code>
state is not required. The following describes the purpose of this <em>pseudo</em>
state. There are two reasons one additional state is needed.</p>
<p>The first reason is that <code class="docutils literal notranslate"><span class="pre">EG_SetState()</span></code> and <code class="docutils literal notranslate"><span class="pre">EG_SetSubstate()</span></code>
needed some state to set the <code class="docutils literal notranslate"><span class="pre">nextState</span></code> and <code class="docutils literal notranslate"><span class="pre">nextSubstate</span></code> members
of the struct to some valid value after the <code class="docutils literal notranslate"><span class="pre">nextState</span></code> is transferred to
<code class="docutils literal notranslate"><span class="pre">currentState</span></code> and <code class="docutils literal notranslate"><span class="pre">currentSubstate</span></code> member. This must be some value that
is not a real state the state machine could transfer to, but something to
indicate that <code class="docutils literal notranslate"><span class="pre">nextState</span></code> and <code class="docutils literal notranslate"><span class="pre">nextSubstate</span></code> were cleared.
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code> is used for that purpose.</p>
<p>The second reason comes from the initialization of variables in C.
All uninitialized struct variables are initialized with zero, therefore for
this example  also <code class="docutils literal notranslate"><span class="pre">eg_state</span></code>, which is the state variable of this state
machine.
This is guaranteed by the C99 standard. For details see ISO C99 Standard
6.7.8.21 (Language/Declarations/Initialization/21).</p>
<p>State variables store all states. These states are defined by an enum. This was
described in <a class="reference internal" href="#implementation-basics"><span class="std std-ref">Basics</span></a>. The first entry in an unnumbered
enum has the value zero. Not fully explicitly initializing the state variable
would implicitly initialize it with zero.</p>
<div class="literal-block-wrapper docutils container" id="no-initialization-of-state">
<div class="code-block-caption"><span class="caption-number">Listing 8.33 </span><span class="caption-text">No initialization of the state variable <code class="docutils literal notranslate"><span class="pre">eg_state</span></code></span><a class="headerlink" href="#no-initialization-of-state" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="n">eg_state</span><span class="p">;</span><span class="w"></span>
<span class="linenos">2</span><span class="w"> </span><span class="cm">/* equals to: EG_STATE_s eg_state = {0}; */</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>In order to prevent <strong>not</strong> thinking about the initialization of the state
members, the first state is the second enum entry (in this example
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_HAS_NEVER_RUN</span></code>).
This equals integer value <cite>1</cite>, not <cite>0</cite>. This forces the developer to think
about initialization and think how the state variable (here <code class="docutils literal notranslate"><span class="pre">eg_state</span></code>) needs
to be initialized. In combination with the implementation pattern of the
<code class="docutils literal notranslate"><span class="pre">EG_RunStateMachine()</span></code> the state machine only starts if the initialization
is correctly done.</p>
</div>
</div>
<div class="section" id="description-of-the-implementation-of-state-processing-functions">
<span id="state-processing-functions"></span><h3><span class="section-number">8.2.3.2.3. </span>Description of the Implementation of State Processing Functions<a class="headerlink" href="#description-of-the-implementation-of-state-processing-functions" title="Permalink to this headline"></a></h3>
<p>Functions that <em>process</em> a specific state are referred to as
<em>state processing functions</em>.</p>
<p>State processing functions <strong>MUST</strong> use
the naming pattern <code class="docutils literal notranslate"><span class="pre">{MODULE_PREFIX}_Process{StateName}State</span></code> where
<code class="docutils literal notranslate"><span class="pre">StateName</span></code> is the state to be processed, e.g., for the state
<strong>Initialization</strong> <code class="docutils literal notranslate"><span class="pre">StateName</span></code> needs to be replaced by
<code class="docutils literal notranslate"><span class="pre">Initialization</span></code>.</p>
<p>State processing functions always return the next state to transition to. A
variable called <code class="docutils literal notranslate"><span class="pre">nextState</span></code> <strong>MUST</strong> be defined locally in such functions.
This variable <strong>MUST</strong> always be initialized with the state this state
processing function implements.</p>
<p>Generally the <code class="docutils literal notranslate"><span class="pre">nextState</span></code> variables definition follows the following pattern
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATES_e</span> <span class="pre">nextState</span> <span class="pre">=</span> <span class="pre">EG_FSM_STATE_{SOME_STATE}</span></code> where <code class="docutils literal notranslate"><span class="pre">{SOME_STATE}</span></code>
needs to be replaced with the state this function is processing. For example,
as the function <code class="docutils literal notranslate"><span class="pre">EG_ProcessInitializationState()</span></code> process the state
<strong>Initialization</strong> the correct state to initialize <code class="docutils literal notranslate"><span class="pre">nextState</span></code> with is
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_INITIALIZATION</span></code>. The example in
<a class="reference internal" href="#example-of-next-state-initialization"><span class="std std-numref">Listing 8.34</span></a> shows this more detailed for
<code class="docutils literal notranslate"><span class="pre">EG_ProcessInitializationState()</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="example-of-next-state-initialization">
<div class="code-block-caption"><span class="caption-number">Listing 8.34 </span><span class="caption-text">Example of <code class="docutils literal notranslate"><span class="pre">nextState</span></code> initialization</span><a class="headerlink" href="#example-of-next-state-initialization" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">2</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos">3</span><span class="w">     </span><span class="cm">/* code */</span><span class="w"></span>
<span class="linenos">4</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">nextState</span><span class="p">;</span><span class="w"></span>
<span class="linenos">5</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>At next the state processing functions <code class="docutils literal notranslate"><span class="pre">EG_ProcessInitializationState()</span></code>
and <code class="docutils literal notranslate"><span class="pre">EG_ProcessRunningState()</span></code> are explained.</p>
<div class="section" id="eg-processinitializationstate">
<h4><span class="section-number">8.2.3.2.3.1. </span><code class="docutils literal notranslate"><span class="pre">EG_ProcessInitializationState()</span></code><a class="headerlink" href="#eg-processinitializationstate" title="Permalink to this headline"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section uses the function <code class="docutils literal notranslate"><span class="pre">EG_SetSubstate()</span></code>. The detailed
explanation of <code class="docutils literal notranslate"><span class="pre">EG_SetSubstate()</span></code> is found later in the text in
<a class="reference internal" href="#function-set-substate"><span class="std std-numref">Section 8.2.3.3.3</span></a>.</p>
</div>
<p>The initialization state has three substates (<strong>I</strong><sub>0</sub>,
<strong>I</strong><sub>1</sub>, <strong>I</strong><sub>exit</sub>) that are run
sequentially.
The Entry substate (from the enums boilerplate) just transfers the state
machine in the first initialization substate <strong>I</strong><sub>0</sub>.
There is no error handling required and code reads as simple as follows:</p>
<div class="literal-block-wrapper docutils container" id="initialization-transferring-from-entry-to-initialization-0">
<div class="code-block-caption"><span class="caption-number">Listing 8.35 </span><span class="caption-text">Transferring from the Entry state in first initialization substate
<strong>I</strong><sub>0</sub></span><a class="headerlink" href="#initialization-transferring-from-entry-to-initialization-0" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_ENTRY</span><span class="p">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">             </span><span class="cm">/* Nothing to do, just transfer to next substate */</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">             </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_0</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos"> 7</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">         </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">10</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>In the first substate <strong>I</strong><sub>0</sub> some work needs to be done
(hypothetically for this example). This work is implemented in a function
<code class="docutils literal notranslate"><span class="pre">EG_SomeInitializationFunction0()</span></code> that returns either <code class="docutils literal notranslate"><span class="pre">true</span></code> (if
successful) or <code class="docutils literal notranslate"><span class="pre">false</span></code> (if unsuccessful). If it was unsuccessful, the
substate <strong>I</strong><sub>0</sub> failed and the state machine needs to
transfer into the state <strong>Error</strong>. If this substate was successful the
<strong>Initialization</strong> state should precede with the second substate
<strong>I</strong><sub>1</sub>. The code below shows the implementation.</p>
<div class="literal-block-wrapper docutils container" id="initialization-transferring-from-initialization-0-to-initialization-1">
<div class="code-block-caption"><span class="caption-number">Listing 8.36 </span><span class="caption-text">Transferring from the first initialization substate
<strong>I</strong><sub>0</sub> to second initialization substate
<strong>I</strong><sub>1</sub></span><a class="headerlink" href="#initialization-transferring-from-initialization-0-to-initialization-1" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">         </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_INITIALIZATION_0</span><span class="p">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeInitializationFunction0</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">                 </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_1</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos"> 8</span><span class="w">             </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">                 </span><span class="cm">/* Something might go wrong, so transition to error state */</span><span class="w"></span>
<span class="hll"><span class="linenos">10</span><span class="w">                 </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">11</span><span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">13</span><span class="w">         </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">14</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Transferring from initialization substate <strong>I</strong><sub>1</sub> to
initialization substate <strong>I</strong><sub>exit</sub> works similar, therefore
this implementation is left out. At next the transition from the initialization
substate <strong>I</strong><sub>exit</sub> into the next state, the first running
substate <strong>R</strong><sub>0</sub>, is shown. The function
<code class="docutils literal notranslate"><span class="pre">EG_SomeInitializationFunctionExit()</span></code> behaves the same way
<code class="docutils literal notranslate"><span class="pre">EG_SomeInitializationFunction0()</span></code> above does. This leads to the following
implementation:</p>
<div class="literal-block-wrapper docutils container" id="initialization-transferring-from-initialization-exit-to-running-0">
<div class="code-block-caption"><span class="caption-number">Listing 8.37 </span><span class="caption-text">Transferring from the last initialization substate
<strong>I</strong><sub>exit</sub> to first running substate
<strong>R</strong><sub>0</sub></span><a class="headerlink" href="#initialization-transferring-from-initialization-exit-to-running-0" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">         </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_INITIALIZATION_EXIT</span><span class="p">:</span><span class="w"></span>
<span class="hll"><span class="linenos"> 6</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeInitializationFunctionExit</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="linenos"> 7</span><span class="w">                 </span><span class="cm">/* Initialization was successful, so transition to running state */</span><span class="w"></span>
<span class="hll"><span class="linenos"> 8</span><span class="w">                 </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos"> 9</span><span class="w">             </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">                 </span><span class="cm">/* Something might go wrong, so transition to error state */</span><span class="w"></span>
<span class="hll"><span class="linenos">11</span><span class="w">                 </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
</span><span class="linenos">12</span><span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">         </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">default</span></code> case is implemented to assert on illegal substates:</p>
<div class="literal-block-wrapper docutils container" id="initialization-assert-on-illegal-substate">
<div class="code-block-caption"><span class="caption-number">Listing 8.38 </span><span class="caption-text">Assertion on illegal substate</span><a class="headerlink" href="#initialization-assert-on-illegal-substate" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">2</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos">3</span><span class="w">     </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">4</span><span class="w">         </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">5</span><span class="w">     </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="hll"><span class="linenos">6</span><span class="w">         </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"></span>
</span><span class="linenos">7</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="cm">/* LCOV_EXCL_LINE */</span><span class="w"></span>
<span class="linenos">8</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">9</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="eg-processrunningstate">
<h4><span class="section-number">8.2.3.2.3.2. </span><code class="docutils literal notranslate"><span class="pre">EG_ProcessRunningState()</span></code><a class="headerlink" href="#eg-processrunningstate" title="Permalink to this headline"></a></h4>
<p>The state <strong>Running</strong> consists of three substates that are looped in order
(
<strong>R</strong><sub>0</sub>,
<strong>R</strong><sub>1</sub>,
<strong>R</strong><sub>2</sub>,
<strong>R</strong><sub>0</sub>,
<strong>R</strong><sub>1</sub>,
<strong>R</strong><sub>2</sub>,
<strong>R</strong><sub>0</sub>,
…) as long as no error occurs. If an error occurs in any <strong>Running</strong>
state’s substates the next state is the state <strong>Error</strong>.</p>
<p>In all of the <strong>Running</strong> state’s substates some work needs to be done
(again, hypothetically for this example). This work is implemented in the
functions
<code class="docutils literal notranslate"><span class="pre">EG_SomeRunningFunction0()</span></code> for substate <strong>R</strong><sub>0</sub>,
<code class="docutils literal notranslate"><span class="pre">EG_SomeRunningFunction1()</span></code> for substate <strong>R</strong><sub>1</sub> and
<code class="docutils literal notranslate"><span class="pre">EG_SomeRunningFunction2()</span></code> for substate <strong>R</strong><sub>2</sub>
that return either <code class="docutils literal notranslate"><span class="pre">true</span></code> (if successful) or <code class="docutils literal notranslate"><span class="pre">false</span></code> (if unsuccessful).
If it was unsuccessful, the respective next state is the state <strong>Error</strong>.
If it was successful, the respective next substate will be run. The
implementation is shown below:</p>
<div class="literal-block-wrapper docutils container" id="running-state-processing-function">
<div class="code-block-caption"><span class="caption-number">Listing 8.39 </span><span class="caption-text">The <strong>Running</strong> and its substates implemented in its state
processing function</span><a class="headerlink" href="#running-state-processing-function" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessRunningState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_ENTRY</span><span class="p">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">             </span><span class="cm">/* Nothing to do, just transfer to next substate */</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">             </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">:</span><span class="w"></span>
<span class="linenos">10</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeRunningFunction0</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">                 </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_1</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="w">             </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">                 </span><span class="cm">/* Something might go wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">14</span><span class="w">                 </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="linenos">16</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_RUNNING_1</span><span class="p">:</span><span class="w"></span>
<span class="linenos">19</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeRunningFunction1</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">                 </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_2</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="w">             </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">22</span><span class="w">                 </span><span class="cm">/* Something might go wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">23</span><span class="w">                 </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">24</span><span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="linenos">25</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_RUNNING_2</span><span class="p">:</span><span class="w"></span>
<span class="linenos">28</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeRunningFunction2</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">29</span><span class="w">                 </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">30</span><span class="w">             </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">31</span><span class="w">                 </span><span class="cm">/* Something might go wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">32</span><span class="w">                 </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="linenos">34</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">         </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="linenos">37</span><span class="w">             </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"></span>
<span class="linenos">38</span><span class="w">             </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="cm">/* LCOV_EXCL_LINE */</span><span class="w"></span>
<span class="linenos">39</span><span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="linenos">40</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">nextState</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="generic-functions-used-in-the-state-machine">
<h2><span class="section-number">8.2.3.3. </span>Generic Functions Used in the State Machine<a class="headerlink" href="#generic-functions-used-in-the-state-machine" title="Permalink to this headline"></a></h2>
<p>The following functions (<code class="docutils literal notranslate"><span class="pre">EG_CheckMultipleCalls</span></code>, <code class="docutils literal notranslate"><span class="pre">EG_SetState</span></code>,
<code class="docutils literal notranslate"><span class="pre">EG_SetSubstate</span></code>) are needed for all state machines.</p>
<div class="section" id="eg-checkmultiplecalls">
<span id="function-check-reentrance"></span><h3><span class="section-number">8.2.3.3.1. </span><code class="docutils literal notranslate"><span class="pre">EG_CheckMultipleCalls()</span></code><a class="headerlink" href="#eg-checkmultiplecalls" title="Permalink to this headline"></a></h3>
<p>The state machine trigger function (here <code class="docutils literal notranslate"><span class="pre">EG_Trigger</span></code>) <strong>MUST</strong> only be
called time or event triggered and <strong>MUST NOT</strong> be called multiple times (no
<em>reentrance</em>).</p>
<p><code class="docutils literal notranslate"><span class="pre">EG_CheckMultipleCalls()</span></code> checks based on <code class="docutils literal notranslate"><span class="pre">triggerEntry</span></code> if the function
is called only one time. The <code class="docutils literal notranslate"><span class="pre">triggerEntry</span></code> variable must be incremented once
in each call of this function. It must be decremented once in every call of the
trigger function, no matter what the trigger function does (this means even if
the timer has not elapsed).</p>
</div>
<div class="section" id="eg-setstate">
<span id="function-set-state"></span><h3><span class="section-number">8.2.3.3.2. </span><code class="docutils literal notranslate"><span class="pre">EG_SetState()</span></code><a class="headerlink" href="#eg-setstate" title="Permalink to this headline"></a></h3>
<p>This function sets the next state. The following steps are performed:</p>
<ul class="simple">
<li><p>setting the idle time of a state and</p></li>
<li><p>setting the state and substate.</p></li>
</ul>
<p>Function behavior:</p>
<p>If neither, the state or substate have changed, there is no action to be taken.
If the state has changed, the state <strong>and</strong> the substate need to change. The
state is set to the next state and the substate is set to the entry state
for substates (<code class="docutils literal notranslate"><span class="pre">EG_FSM_SUBSTATE_ENTRY</span></code>). After that the <code class="docutils literal notranslate"><span class="pre">nextState</span></code> and
<code class="docutils literal notranslate"><span class="pre">nextSubstate</span></code> of state and substate can be cleared (set  to
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_DUMMY</span></code> and <code class="docutils literal notranslate"><span class="pre">EG_FSM_SUBSTATE_DUMMY</span></code> respectively).
If the state has not changed, and only the substate has, the next substate
is set by <code class="docutils literal notranslate"><span class="pre">EG_SetSubstate()</span></code>.</p>
<p>This implementation requires that every state has a defined entry for all
states and all states need to implement that entry. This also ensure no state
transitions from e.g.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">State</span> <span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">third</span> <span class="pre">substate</span></code> into</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">State</span> <span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">second</span> <span class="pre">substate</span></code></p></li>
</ul>
<p>are made, but a strict chain needs to be followed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">State</span> <span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">third</span> <span class="pre">substate</span></code> into</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">State</span> <span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">first</span> <span class="pre">substate</span></code> (<code class="docutils literal notranslate"><span class="pre">EG_FSM_SUBSTATE_ENTRY</span></code>) into</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">State</span> <span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">second</span> <span class="pre">substate</span></code>.</p></li>
</ul>
<p><strong>What if there is no substate in a case?</strong>: There might be states that do not
need substate, even this example has three states with no substates (
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_HAS_NEVER_RUN</span></code>, <code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_UNINITIALIZED</span></code> and
<code class="docutils literal notranslate"><span class="pre">EG_FSM_STATE_ERROR</span></code>). In this case just the transition(s) in the next
state(s) need to be implemented and no state processing function needs to be
implemented. Therefore setting the substate implicitly by using the
<code class="docutils literal notranslate"><span class="pre">EG_SetState</span></code> is fine, as the substate is ignored in that case and it
is correctly set to entry (<code class="docutils literal notranslate"><span class="pre">EG_FSM_SUBSTATE_ENTRY</span></code>) for the next case, whether
this state implements substates or not.</p>
</div>
<div class="section" id="eg-setsubstate">
<span id="function-set-substate"></span><h3><span class="section-number">8.2.3.3.3. </span><code class="docutils literal notranslate"><span class="pre">EG_SetSubstate()</span></code><a class="headerlink" href="#eg-setsubstate" title="Permalink to this headline"></a></h3>
<p>This function only sets the <strong>sub</strong>state.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">currentSubstate</span></code> is set to the next substate, the <code class="docutils literal notranslate"><span class="pre">nextSubstate</span></code> can
be cleared. This is done by setting it to the dummy substate
(<code class="docutils literal notranslate"><span class="pre">EG_FSM_SUBSTATE_DUMMY</span></code>).</p>
</div>
</div>
<div class="section" id="extended-example-with-recoverable-error">
<span id="recoverable-error"></span><h2><span class="section-number">8.2.3.4. </span>Extended Example With Recoverable Error<a class="headerlink" href="#extended-example-with-recoverable-error" title="Permalink to this headline"></a></h2>
<p>There are cases where an error during the processing of the state machine can
occur and there are strategies to recover from them. The example from
<a class="reference internal" href="#state-diagram"><span class="std std-numref">Fig. 8.1</span></a> is extended as follows:</p>
<div class="figure align-default" id="state-diagram-recoverable">
<div class="graphviz"><img src="../../_images/graphviz-6cfeda0e3bb5c72e6213350bdeced01b3dfec786.png" alt="# Copyright (c) 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V.
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.
#
# 3. Neither the name of the copyright holder nor the names of its
#    contributors may be used to endorse or promote products derived from
#    this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# We kindly request you to use one or more of the following phrases to refer to
# foxBMS in your hardware, software, documentation or advertising materials:
#
# - &quot;This product uses parts of foxBMS®&quot;
# - &quot;This product includes parts of foxBMS®&quot;
# - &quot;This product is derived from foxBMS®&quot;

digraph fsm_recoverable_error {
    rankdir=LR;
    size=&quot;8,5&quot;
    node [shape = doublecircle] nd_uninitialized nd_error;
    node [shape = circle] nd_initialization nd_running;

    nd_uninitialized        [label=&lt;&lt;B&gt;Uninitialized&lt;/B&gt;&gt;];
    nd_error                [label=&lt;&lt;B&gt;Error&lt;/B&gt;&gt;];
    nd_initialization       [label=&lt;&lt;B&gt;Initialization&lt;/B&gt;&gt;];
    nd_running              [label=&lt;&lt;B&gt;Running&lt;/B&gt;&gt;];

    nd_uninitialized -&gt;nd_initialization    [label = &quot;Initialize&quot;];
    nd_initialization -&gt; nd_running         [label = &quot;&quot;];
    nd_running -&gt; nd_error                  [label = &quot;Runtime error&quot;];
    nd_running -&gt; nd_running                [label = &quot;Operational mode&quot;];
    nd_error -&gt; nd_uninitialized            [ style=dashed, label = &quot;Recover&quot; ];
    nd_initialization -&gt; nd_error           [label = &quot;Initialization error&quot;];
}" class="graphviz" /></div>
<p class="caption"><span class="caption-number">Fig. 8.4 </span><span class="caption-text">Example with recoverable error</span><a class="headerlink" href="#state-diagram-recoverable" title="Permalink to this image"></a></p>
</div>
<p>To implement this behavior, the error case needs to be changed to something
like shown in <a class="reference internal" href="#the-recoverable-error-state"><span class="std std-numref">Listing 8.40</span></a>. There is a state function
<code class="docutils literal notranslate"><span class="pre">EG_ProcessErrorState()</span></code> to process the error case and there might be an option
to re-initialize the state machine based on the type of error.</p>
<div class="literal-block-wrapper docutils container" id="the-recoverable-error-state">
<div class="code-block-caption"><span class="caption-number">Listing 8.40 </span><span class="caption-text">The error state</span><a class="headerlink" href="#the-recoverable-error-state" title="Permalink to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 2</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">     </span><span class="cm">/****************************************************** STATE: ERROR */</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_ERROR</span><span class="p">:</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">         </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_ProcessErrorState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">             </span><span class="cm">/* staying in error state, processed by state function */</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_UNINITIALIZED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">             </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_UNINITIALIZED</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">10</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">11</span><span class="w">             </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Something went wrong */</span><span class="w"></span>
<span class="linenos">12</span><span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">     </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="linenos">15</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="full-example-code">
<h2><span class="section-number">8.2.3.5. </span>Full Example Code<a class="headerlink" href="#full-example-code" title="Permalink to this headline"></a></h2>
<p>The full implementation of this state machine is found in
<a class="reference internal" href="#state-machine-h"><span class="std std-numref">Listing 8.41</span></a> and <a class="reference internal" href="#state-machine-c"><span class="std std-numref">Listing 8.42</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="state-machine-h">
<div class="code-block-caption"><span class="caption-number">Listing 8.41 </span><span class="caption-text">The header of the state machine</span><a class="headerlink" href="#state-machine-h" title="Permalink to this code"></a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/**</span>
<span class="linenos">  2</span><span class="cm"> *</span>
<span class="linenos">  3</span><span class="cm"> * @copyright &amp;copy; 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V.</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> *</span>
<span class="linenos">  6</span><span class="cm"> * SPDX-License-Identifier: BSD-3-Clause</span>
<span class="linenos">  7</span><span class="cm"> *</span>
<span class="linenos">  8</span><span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="linenos">  9</span><span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="linenos"> 10</span><span class="cm"> *</span>
<span class="linenos"> 11</span><span class="cm"> * 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="linenos"> 12</span><span class="cm"> *    list of conditions and the following disclaimer.</span>
<span class="linenos"> 13</span><span class="cm"> *</span>
<span class="linenos"> 14</span><span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 15</span><span class="cm"> *    this list of conditions and the following disclaimer in the documentation</span>
<span class="linenos"> 16</span><span class="cm"> *    and/or other materials provided with the distribution.</span>
<span class="linenos"> 17</span><span class="cm"> *</span>
<span class="linenos"> 18</span><span class="cm"> * 3. Neither the name of the copyright holder nor the names of its</span>
<span class="linenos"> 19</span><span class="cm"> *    contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 20</span><span class="cm"> *    this software without specific prior written permission.</span>
<span class="linenos"> 21</span><span class="cm"> *</span>
<span class="linenos"> 22</span><span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="linenos"> 23</span><span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="linenos"> 24</span><span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="linenos"> 25</span><span class="cm"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="linenos"> 26</span><span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="linenos"> 27</span><span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="linenos"> 28</span><span class="cm"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="linenos"> 29</span><span class="cm"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="linenos"> 30</span><span class="cm"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="linenos"> 31</span><span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="linenos"> 32</span><span class="cm"> *</span>
<span class="linenos"> 33</span><span class="cm"> * We kindly request you to use one or more of the following phrases to refer to</span>
<span class="linenos"> 34</span><span class="cm"> * foxBMS in your hardware, software, documentation or advertising materials:</span>
<span class="linenos"> 35</span><span class="cm"> *</span>
<span class="linenos"> 36</span><span class="cm"> * - &amp;Prime;This product uses parts of foxBMS&amp;reg;&amp;Prime;</span>
<span class="linenos"> 37</span><span class="cm"> * - &amp;Prime;This product includes parts of foxBMS&amp;reg;&amp;Prime;</span>
<span class="linenos"> 38</span><span class="cm"> * - &amp;Prime;This product is derived from foxBMS&amp;reg;&amp;Prime;</span>
<span class="linenos"> 39</span><span class="cm"> *</span>
<span class="linenos"> 40</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="cm">/**</span>
<span class="linenos"> 43</span><span class="cm"> * @file    state-machine.h</span>
<span class="linenos"> 44</span><span class="cm"> * @author  foxBMS Team</span>
<span class="linenos"> 45</span><span class="cm"> * @date    2020-10-29 (date of creation)</span>
<span class="linenos"> 46</span><span class="cm"> * @updated 2023-02-03 (date of last update)</span>
<span class="linenos"> 47</span><span class="cm"> * @version v1.5.0</span>
<span class="linenos"> 48</span><span class="cm"> * @ingroup STATE_MACHINE</span>
<span class="linenos"> 49</span><span class="cm"> * @prefix  EG</span>
<span class="linenos"> 50</span><span class="cm"> *</span>
<span class="linenos"> 51</span><span class="cm"> * @brief   Header file of some software</span>
<span class="linenos"> 52</span><span class="cm"> *</span>
<span class="linenos"> 53</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="cp">#ifndef FOXBMS__STATE_MACHINE_H_</span>
<span class="linenos"> 56</span><span class="cp">#define FOXBMS__STATE_MACHINE_H_</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="cm">/*========== Includes =======================================================*/</span><span class="w"></span>
<span class="linenos"> 59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fstd_types.h&quot;</span><span class="cp"></span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="cm">/*========== Macros and Definitions =========================================*/</span><span class="w"></span>
<span class="linenos"> 64</span><span class="cm">/** States of the state machine */</span><span class="w"></span>
<span class="linenos"> 65</span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">EG_FSM_STATE_DUMMY</span><span class="p">,</span><span class="w">          </span><span class="cm">/*!&lt; dummy state - always the first state */</span><span class="w"></span>
<span class="linenos"> 67</span><span class="w">    </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w">  </span><span class="cm">/*!&lt; never run state - always the second state */</span><span class="w"></span>
<span class="linenos"> 68</span><span class="w">    </span><span class="n">EG_FSM_STATE_UNINITIALIZED</span><span class="p">,</span><span class="w">  </span><span class="cm">/*!&lt; uninitialized state */</span><span class="w"></span>
<span class="linenos"> 69</span><span class="w">    </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">,</span><span class="w"> </span><span class="cm">/*!&lt; initializing the state machine */</span><span class="w"></span>
<span class="linenos"> 70</span><span class="w">    </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">,</span><span class="w">        </span><span class="cm">/*!&lt; operational mode of the state machine  */</span><span class="w"></span>
<span class="linenos"> 71</span><span class="w">    </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">,</span><span class="w">          </span><span class="cm">/*!&lt; state for error processing  */</span><span class="w"></span>
<span class="linenos"> 72</span><span class="p">}</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="cm">/** Substates of the state machine */</span><span class="w"></span>
<span class="linenos"> 75</span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w">               </span><span class="cm">/*!&lt; dummy state - always the first substate */</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w">               </span><span class="cm">/*!&lt; entry state - always the second substate */</span><span class="w"></span>
<span class="linenos"> 78</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_0</span><span class="p">,</span><span class="w">    </span><span class="cm">/*!&lt; fist initialization substate */</span><span class="w"></span>
<span class="linenos"> 79</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_1</span><span class="p">,</span><span class="w">    </span><span class="cm">/*!&lt; second initialization substate */</span><span class="w"></span>
<span class="linenos"> 80</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_EXIT</span><span class="p">,</span><span class="w"> </span><span class="cm">/*!&lt; last initialization substate */</span><span class="w"></span>
<span class="linenos"> 81</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">,</span><span class="w">           </span><span class="cm">/*!&lt; fist running substate */</span><span class="w"></span>
<span class="linenos"> 82</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_RUNNING_1</span><span class="p">,</span><span class="w">           </span><span class="cm">/*!&lt; second running substate */</span><span class="w"></span>
<span class="linenos"> 83</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATE_RUNNING_2</span><span class="p">,</span><span class="w">           </span><span class="cm">/*!&lt; third running substate */</span><span class="w"></span>
<span class="linenos"> 84</span><span class="p">}</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="cm">/** some struct with some information */</span><span class="w"></span>
<span class="linenos"> 87</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="linenos"> 88</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">r0</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; some info 0 */</span><span class="w"></span>
<span class="linenos"> 89</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">r1</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; some info 1 */</span><span class="w"></span>
<span class="linenos"> 90</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">r2</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; some info 2 */</span><span class="w"></span>
<span class="linenos"> 91</span><span class="p">}</span><span class="w"> </span><span class="n">EG_INFORMATION_s</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="cm">/** This struct describes the state of the monitoring instance */</span><span class="w"></span>
<span class="linenos"> 94</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="linenos"> 95</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span><span class="w">                      </span><span class="cm">/*!&lt; timer of the state */</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">triggerEntry</span><span class="p">;</span><span class="w">                </span><span class="cm">/*!&lt; trigger entry of the state */</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; next state of the FSM */</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">currentState</span><span class="p">;</span><span class="w">        </span><span class="cm">/*!&lt; current state of the FSM */</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">previousState</span><span class="p">;</span><span class="w">       </span><span class="cm">/*!&lt; previous state of the FSM */</span><span class="w"></span>
<span class="linenos">100</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">;</span><span class="w">     </span><span class="cm">/*!&lt; next substate of the FSM */</span><span class="w"></span>
<span class="linenos">101</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">currentSubstate</span><span class="p">;</span><span class="w">  </span><span class="cm">/*!&lt; current substate of the FSM */</span><span class="w"></span>
<span class="linenos">102</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">previousSubstate</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; previous substate of the FSM */</span><span class="w"></span>
<span class="linenos">103</span><span class="w">    </span><span class="n">EG_INFORMATION_s</span><span class="w"> </span><span class="n">information</span><span class="p">;</span><span class="w">        </span><span class="cm">/*!&lt; Some information to be stored */</span><span class="w"></span>
<span class="linenos">104</span><span class="p">}</span><span class="w"> </span><span class="n">EG_STATE_s</span><span class="p">;</span><span class="w"></span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="cm">/*========== Extern Constant and Variable Declarations ======================*/</span><span class="w"></span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="cm">/** state of the example state machine */</span><span class="w"></span>
<span class="linenos">109</span><span class="k">extern</span><span class="w"> </span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="n">eg_state</span><span class="p">;</span><span class="w"></span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="cm">/*========== Extern Function Prototypes =====================================*/</span><span class="w"></span>
<span class="linenos">112</span><span class="cm">/**</span>
<span class="linenos">113</span><span class="cm"> * @brief   tick function, call this to advance the state machine</span>
<span class="linenos">114</span><span class="cm"> * @param   pEgState current state of the state machine</span>
<span class="linenos">115</span><span class="cm"> * @returns returns always #STD_OK</span>
<span class="linenos">116</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">117</span><span class="k">extern</span><span class="w"> </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="nf">EG_Trigger</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">118</span>
<span class="linenos">119</span><span class="cm">/*========== Externalized Static Functions Prototypes (Unit Test) ===========*/</span><span class="w"></span>
<span class="linenos">120</span><span class="cp">#ifdef UNITY_UNIT_TEST</span>
<span class="linenos">121</span><span class="cp">#endif</span>
<span class="linenos">122</span>
<span class="linenos">123</span><span class="cp">#endif </span><span class="cm">/* FOXBMS__STATE_MACHINE_H_ */</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="state-machine-c">
<div class="code-block-caption"><span class="caption-number">Listing 8.42 </span><span class="caption-text">The implementation of the state machine</span><a class="headerlink" href="#state-machine-c" title="Permalink to this code"></a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/**</span>
<span class="linenos">  2</span><span class="cm"> *</span>
<span class="linenos">  3</span><span class="cm"> * @copyright &amp;copy; 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V.</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> *</span>
<span class="linenos">  6</span><span class="cm"> * SPDX-License-Identifier: BSD-3-Clause</span>
<span class="linenos">  7</span><span class="cm"> *</span>
<span class="linenos">  8</span><span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="linenos">  9</span><span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="linenos"> 10</span><span class="cm"> *</span>
<span class="linenos"> 11</span><span class="cm"> * 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="linenos"> 12</span><span class="cm"> *    list of conditions and the following disclaimer.</span>
<span class="linenos"> 13</span><span class="cm"> *</span>
<span class="linenos"> 14</span><span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 15</span><span class="cm"> *    this list of conditions and the following disclaimer in the documentation</span>
<span class="linenos"> 16</span><span class="cm"> *    and/or other materials provided with the distribution.</span>
<span class="linenos"> 17</span><span class="cm"> *</span>
<span class="linenos"> 18</span><span class="cm"> * 3. Neither the name of the copyright holder nor the names of its</span>
<span class="linenos"> 19</span><span class="cm"> *    contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 20</span><span class="cm"> *    this software without specific prior written permission.</span>
<span class="linenos"> 21</span><span class="cm"> *</span>
<span class="linenos"> 22</span><span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="linenos"> 23</span><span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="linenos"> 24</span><span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="linenos"> 25</span><span class="cm"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="linenos"> 26</span><span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="linenos"> 27</span><span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="linenos"> 28</span><span class="cm"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="linenos"> 29</span><span class="cm"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="linenos"> 30</span><span class="cm"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="linenos"> 31</span><span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="linenos"> 32</span><span class="cm"> *</span>
<span class="linenos"> 33</span><span class="cm"> * We kindly request you to use one or more of the following phrases to refer to</span>
<span class="linenos"> 34</span><span class="cm"> * foxBMS in your hardware, software, documentation or advertising materials:</span>
<span class="linenos"> 35</span><span class="cm"> *</span>
<span class="linenos"> 36</span><span class="cm"> * - &amp;Prime;This product uses parts of foxBMS&amp;reg;&amp;Prime;</span>
<span class="linenos"> 37</span><span class="cm"> * - &amp;Prime;This product includes parts of foxBMS&amp;reg;&amp;Prime;</span>
<span class="linenos"> 38</span><span class="cm"> * - &amp;Prime;This product is derived from foxBMS&amp;reg;&amp;Prime;</span>
<span class="linenos"> 39</span><span class="cm"> *</span>
<span class="linenos"> 40</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="cm">/**</span>
<span class="linenos"> 43</span><span class="cm"> * @file    state-machine.c</span>
<span class="linenos"> 44</span><span class="cm"> * @author  foxBMS Team</span>
<span class="linenos"> 45</span><span class="cm"> * @date    2020-10-29 (date of creation)</span>
<span class="linenos"> 46</span><span class="cm"> * @updated 2023-02-03 (date of last update)</span>
<span class="linenos"> 47</span><span class="cm"> * @version v1.5.0</span>
<span class="linenos"> 48</span><span class="cm"> * @ingroup STATE_MACHINE</span>
<span class="linenos"> 49</span><span class="cm"> * @prefix  EG</span>
<span class="linenos"> 50</span><span class="cm"> *</span>
<span class="linenos"> 51</span><span class="cm"> * @brief   Implementation of some driver that needs a state machine</span>
<span class="linenos"> 52</span><span class="cm"> *</span>
<span class="linenos"> 53</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="cm">/*========== Includes =======================================================*/</span><span class="w"></span>
<span class="linenos"> 56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;state-machine.h&quot;</span><span class="cp"></span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fassert.h&quot;</span><span class="cp"></span>
<span class="linenos"> 59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fstd_types.h&quot;</span><span class="cp"></span>
<span class="linenos"> 60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;os.h&quot;</span><span class="cp"></span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<span class="linenos"> 63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="cm">/*========== Macros and Definitions =========================================*/</span><span class="w"></span>
<span class="linenos"> 66</span><span class="cm">/**</span>
<span class="linenos"> 67</span><span class="cm"> * state machine short time definition in #EG_Trigger calls until next state is</span>
<span class="linenos"> 68</span><span class="cm"> * processed</span>
<span class="linenos"> 69</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos"> 70</span><span class="cp">#define EG_FSM_SHORT_TIME (1u)</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="cm">/**</span>
<span class="linenos"> 73</span><span class="cm"> * state machine medium time definition in #EG_Trigger calls until next</span>
<span class="linenos"> 74</span><span class="cm"> * state/substate is processed</span>
<span class="linenos"> 75</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos"> 76</span><span class="cp">#define EG_FSM_MEDIUM_TIME (5u)</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="cm">/**</span>
<span class="linenos"> 79</span><span class="cm"> * state machine long time definition in #EG_Trigger calls until next</span>
<span class="linenos"> 80</span><span class="cm"> * state/substate is processed</span>
<span class="linenos"> 81</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos"> 82</span><span class="cp">#define EG_FSM_LONG_TIME (10u)</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="cm">/** Symbolic names to check for multiple calls of #EG_Trigger */</span><span class="w"></span>
<span class="linenos"> 85</span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">    </span><span class="n">EG_MULTIPLE_CALLS_NO</span><span class="p">,</span><span class="w">  </span><span class="cm">/*!&lt; no multiple calls, OK */</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">    </span><span class="n">EG_MULTIPLE_CALLS_YES</span><span class="p">,</span><span class="w"> </span><span class="cm">/*!&lt; multiple calls, not OK */</span><span class="w"></span>
<span class="linenos"> 88</span><span class="p">}</span><span class="w"> </span><span class="n">EG_CHECK_MULTIPLE_CALLS_e</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span><span class="cm">/*========== Static Constant and Variable Definitions =======================*/</span><span class="w"></span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="cm">/*========== Extern Constant and Variable Definitions =======================*/</span><span class="w"></span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="cm">/** local instance of the driver-state */</span><span class="w"></span>
<span class="linenos"> 95</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="n">eg_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">    </span><span class="p">.</span><span class="n">timer</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">    </span><span class="p">.</span><span class="n">triggerEntry</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">    </span><span class="p">.</span><span class="n">nextState</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">    </span><span class="p">.</span><span class="n">currentState</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w"></span>
<span class="linenos">100</span><span class="w">    </span><span class="p">.</span><span class="n">previousState</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">,</span><span class="w"></span>
<span class="linenos">101</span><span class="w">    </span><span class="p">.</span><span class="n">nextSubstate</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w"></span>
<span class="linenos">102</span><span class="w">    </span><span class="p">.</span><span class="n">currentSubstate</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w"></span>
<span class="linenos">103</span><span class="w">    </span><span class="p">.</span><span class="n">previousSubstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">,</span><span class="w"></span>
<span class="linenos">104</span><span class="w">    </span><span class="p">.</span><span class="n">information</span><span class="p">.</span><span class="n">r0</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos">105</span><span class="w">    </span><span class="p">.</span><span class="n">information</span><span class="p">.</span><span class="n">r1</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos">106</span><span class="w">    </span><span class="p">.</span><span class="n">information</span><span class="p">.</span><span class="n">r2</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="linenos">107</span><span class="p">};</span><span class="w"></span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="cm">/*========== Static Function Prototypes =====================================*/</span><span class="w"></span>
<span class="linenos">110</span><span class="cm">/**</span>
<span class="linenos">111</span><span class="cm"> * @brief   check for multiple calls of state machine trigger function</span>
<span class="linenos">112</span><span class="cm"> * @details The trigger function is not reentrant, which means it cannot</span>
<span class="linenos">113</span><span class="cm"> *          be called multiple times. This functions increments the</span>
<span class="linenos">114</span><span class="cm"> *          triggerEntry counter once and must be called each time the</span>
<span class="linenos">115</span><span class="cm"> *          trigger function is called. If triggerEntry is greater than</span>
<span class="linenos">116</span><span class="cm"> *          one, there were multiple calls. For this function to work,</span>
<span class="linenos">117</span><span class="cm"> *          triggerEntry must be decremented each time the trigger function</span>
<span class="linenos">118</span><span class="cm"> *          is called, even if no processing do because the timer is</span>
<span class="linenos">119</span><span class="cm"> *          non-zero.</span>
<span class="linenos">120</span><span class="cm"> * @param   pEgState state of the fake state machine</span>
<span class="linenos">121</span><span class="cm"> * @return  #EG_MULTIPLE_CALLS_YES if there were multiple calls,</span>
<span class="linenos">122</span><span class="cm"> *          #EG_MULTIPLE_CALLS_NO otherwise</span>
<span class="linenos">123</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">124</span><span class="k">static</span><span class="w"> </span><span class="n">EG_CHECK_MULTIPLE_CALLS_e</span><span class="w"> </span><span class="nf">EG_CheckMultipleCalls</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">125</span>
<span class="linenos">126</span><span class="cm">/**</span>
<span class="linenos">127</span><span class="cm"> * @brief   Sets the next state, the next substate and the timer value</span>
<span class="linenos">128</span><span class="cm"> *          of the state variable.</span>
<span class="linenos">129</span><span class="cm"> * @param   pEgState       state of the example state machine</span>
<span class="linenos">130</span><span class="cm"> * @param   nextState      state to be transferred into</span>
<span class="linenos">131</span><span class="cm"> * @param   nextSubstate   substate to be transferred into</span>
<span class="linenos">132</span><span class="cm"> * @param   idleTime       wait time for the state machine</span>
<span class="linenos">133</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">134</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EG_SetState</span><span class="p">(</span><span class="w"></span>
<span class="linenos">135</span><span class="w">    </span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">,</span><span class="w"></span>
<span class="linenos">136</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="p">,</span><span class="w"></span>
<span class="linenos">137</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">,</span><span class="w"></span>
<span class="linenos">138</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">idleTime</span><span class="p">);</span><span class="w"></span>
<span class="linenos">139</span>
<span class="linenos">140</span><span class="cm">/**</span>
<span class="linenos">141</span><span class="cm"> * @brief   Sets the next substate and the timer value</span>
<span class="linenos">142</span><span class="cm"> *          of the state variable.</span>
<span class="linenos">143</span><span class="cm"> * @param   pEgState       state of the example state machine</span>
<span class="linenos">144</span><span class="cm"> * @param   nextSubstate   substate to be transferred into</span>
<span class="linenos">145</span><span class="cm"> * @param   idleTime       wait time for the state machine</span>
<span class="linenos">146</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">147</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EG_SetSubstate</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">idleTime</span><span class="p">);</span><span class="w"></span>
<span class="linenos">148</span>
<span class="linenos">149</span><span class="cm">/**</span>
<span class="linenos">150</span><span class="cm"> * @brief   dummy function for initialization substate</span>
<span class="linenos">151</span><span class="cm"> *          #EG_FSM_SUBSTATE_INITIALIZATION_0</span>
<span class="linenos">152</span><span class="cm"> * @return  returns always true</span>
<span class="linenos">153</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">154</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeInitializationFunction0</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="linenos">155</span>
<span class="linenos">156</span><span class="cm">/**</span>
<span class="linenos">157</span><span class="cm"> * @brief   dummy function for initialization substate</span>
<span class="linenos">158</span><span class="cm"> *          #EG_FSM_SUBSTATE_INITIALIZATION_1</span>
<span class="linenos">159</span><span class="cm"> * @return  returns always true</span>
<span class="linenos">160</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">161</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeInitializationFunction1</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="linenos">162</span>
<span class="linenos">163</span><span class="cm">/**</span>
<span class="linenos">164</span><span class="cm"> * @brief   dummy function to check if the initialization</span>
<span class="linenos">165</span><span class="cm"> *          step of the state machine was successful</span>
<span class="linenos">166</span><span class="cm"> *          (#EG_FSM_SUBSTATE_INITIALIZATION_1)</span>
<span class="linenos">167</span><span class="cm"> * @return  returns always true</span>
<span class="linenos">168</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">169</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeInitializationFunctionExit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="linenos">170</span>
<span class="linenos">171</span><span class="cm">/**</span>
<span class="linenos">172</span><span class="cm"> * @brief   dummy function making a test to determine</span>
<span class="linenos">173</span><span class="cm"> *          the outcome of substate #EG_FSM_SUBSTATE_RUNNING_0</span>
<span class="linenos">174</span><span class="cm"> * @return  returns always true</span>
<span class="linenos">175</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">176</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeRunningFunction0</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="cm">/**</span>
<span class="linenos">179</span><span class="cm"> * @brief   dummy function making a test to determine</span>
<span class="linenos">180</span><span class="cm"> *          the outcome of substate EG_FSM_SUBSTATE_RUNNING_1</span>
<span class="linenos">181</span><span class="cm"> * @return  returns always true</span>
<span class="linenos">182</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">183</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeRunningFunction1</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="linenos">184</span>
<span class="linenos">185</span><span class="cm">/**</span>
<span class="linenos">186</span><span class="cm"> * @brief   dummy function making a test to determine</span>
<span class="linenos">187</span><span class="cm"> *          the outcome of substate EG_FSM_SUBSTATE_RUNNING_2</span>
<span class="linenos">188</span><span class="cm"> * @return  returns always true</span>
<span class="linenos">189</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">190</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeRunningFunction2</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="linenos">191</span>
<span class="linenos">192</span><span class="cm">/**</span>
<span class="linenos">193</span><span class="cm"> * @brief   Processes the initialization state</span>
<span class="linenos">194</span><span class="cm"> * @param   pEgState state of the example state machine</span>
<span class="linenos">195</span><span class="cm"> * @return  Always #STD_OK</span>
<span class="linenos">196</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">197</span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">198</span>
<span class="linenos">199</span><span class="cm">/**</span>
<span class="linenos">200</span><span class="cm"> * @brief   Processes the running state</span>
<span class="linenos">201</span><span class="cm"> * @param   pEgState state of the example state machine</span>
<span class="linenos">202</span><span class="cm"> * @return  Always #STD_OK</span>
<span class="linenos">203</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">204</span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessRunningState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">205</span>
<span class="linenos">206</span><span class="cm">/**</span>
<span class="linenos">207</span><span class="cm"> * @brief   Defines the state transitions</span>
<span class="linenos">208</span><span class="cm"> * @details This function contains the implementation of the state</span>
<span class="linenos">209</span><span class="cm"> *          machine, i.e., the sequence of states and substates.</span>
<span class="linenos">210</span><span class="cm"> *          It is called by the trigger function every time</span>
<span class="linenos">211</span><span class="cm"> *          the state machine timer has a non-zero value.</span>
<span class="linenos">212</span><span class="cm"> * @param   pEgState state of the example state machine</span>
<span class="linenos">213</span><span class="cm"> * @return  Always #STD_OK</span>
<span class="linenos">214</span><span class="cm"> */</span><span class="w"></span>
<span class="linenos">215</span><span class="k">static</span><span class="w"> </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="nf">EG_RunStateMachine</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">216</span>
<span class="linenos">217</span><span class="cm">/*========== Static Function Implementations ================================*/</span><span class="w"></span>
<span class="linenos">218</span>
<span class="linenos">219</span><span class="k">static</span><span class="w"> </span><span class="n">EG_CHECK_MULTIPLE_CALLS_e</span><span class="w"> </span><span class="nf">EG_CheckMultipleCalls</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">220</span><span class="w">    </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">pEgState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL_PTR</span><span class="p">);</span><span class="w"></span>
<span class="linenos">221</span><span class="w">    </span><span class="n">EG_CHECK_MULTIPLE_CALLS_e</span><span class="w"> </span><span class="n">multipleCalls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_MULTIPLE_CALLS_NO</span><span class="p">;</span><span class="w"></span>
<span class="linenos">222</span><span class="w">    </span><span class="n">OS_EnterTaskCritical</span><span class="p">();</span><span class="w"></span>
<span class="linenos">223</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">triggerEntry</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0u</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">224</span><span class="w">        </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">triggerEntry</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">225</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">226</span><span class="w">        </span><span class="n">multipleCalls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_MULTIPLE_CALLS_YES</span><span class="p">;</span><span class="w"> </span><span class="cm">/* multiple call of function EG_Trigger for instance pEgState */</span><span class="w"></span>
<span class="linenos">227</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">228</span><span class="w">    </span><span class="n">OS_ExitTaskCritical</span><span class="p">();</span><span class="w"></span>
<span class="linenos">229</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">multipleCalls</span><span class="p">;</span><span class="w"></span>
<span class="linenos">230</span><span class="p">}</span><span class="w"></span>
<span class="linenos">231</span>
<span class="linenos">232</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EG_SetState</span><span class="p">(</span><span class="w"></span>
<span class="linenos">233</span><span class="w">    </span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">,</span><span class="w"></span>
<span class="linenos">234</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="p">,</span><span class="w"></span>
<span class="linenos">235</span><span class="w">    </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">,</span><span class="w"></span>
<span class="linenos">236</span><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">idleTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">237</span><span class="w">    </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">pEgState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL_PTR</span><span class="p">);</span><span class="w"></span>
<span class="linenos">238</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">earlyExit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos">239</span>
<span class="linenos">240</span><span class="w">    </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idleTime</span><span class="p">;</span><span class="w"></span>
<span class="linenos">241</span>
<span class="linenos">242</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nextState</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">243</span><span class="w">        </span><span class="cm">/* Next state and next substate equal to current state and substate: nothing to do */</span><span class="w"></span>
<span class="linenos">244</span><span class="w">        </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">nextState</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_DUMMY</span><span class="p">;</span><span class="w">    </span><span class="cm">/* no state transistion required -&gt; reset */</span><span class="w"></span>
<span class="linenos">245</span><span class="w">        </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">nextSubstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">;</span><span class="w"> </span><span class="cm">/* no substate transistion required -&gt; reset */</span><span class="w"></span>
<span class="linenos">246</span><span class="w">        </span><span class="n">earlyExit</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">247</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">248</span>
<span class="linenos">249</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">earlyExit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">250</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nextState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">251</span><span class="w">            </span><span class="cm">/* Next state is different: switch to it and set substate to entry value */</span><span class="w"></span>
<span class="linenos">252</span><span class="w">            </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">previousState</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">;</span><span class="w"></span>
<span class="linenos">253</span><span class="w">            </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">nextState</span><span class="p">;</span><span class="w"></span>
<span class="linenos">254</span><span class="w">            </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">previousSubstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">;</span><span class="w"></span>
<span class="linenos">255</span><span class="w">            </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Use entry state after a top level state change */</span><span class="w"></span>
<span class="linenos">256</span><span class="w">            </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">nextState</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_DUMMY</span><span class="p">;</span><span class="w">    </span><span class="cm">/* no state transistion required -&gt; reset */</span><span class="w"></span>
<span class="linenos">257</span><span class="w">            </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">nextSubstate</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">;</span><span class="w"> </span><span class="cm">/* no substate transistion required -&gt; reset */</span><span class="w"></span>
<span class="linenos">258</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">259</span><span class="w">            </span><span class="cm">/* Only the next substate is different, switch to it */</span><span class="w"></span>
<span class="linenos">260</span><span class="w">            </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">,</span><span class="w"> </span><span class="n">idleTime</span><span class="p">);</span><span class="w"></span>
<span class="linenos">261</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">262</span><span class="w">            </span><span class="p">;</span><span class="w"></span>
<span class="linenos">263</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">264</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">265</span><span class="p">}</span><span class="w"></span>
<span class="linenos">266</span>
<span class="linenos">267</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EG_SetSubstate</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATES_e</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">idleTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">268</span><span class="w">    </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">pEgState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL_PTR</span><span class="p">);</span><span class="w"></span>
<span class="linenos">269</span><span class="w">    </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">timer</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">idleTime</span><span class="p">;</span><span class="w"></span>
<span class="linenos">270</span><span class="w">    </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">previousSubstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">;</span><span class="w"></span>
<span class="linenos">271</span><span class="w">    </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">nextSubstate</span><span class="p">;</span><span class="w"></span>
<span class="linenos">272</span><span class="w">    </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">nextSubstate</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_DUMMY</span><span class="p">;</span><span class="w"> </span><span class="cm">/* substate has been set, now reset value for nextSubstate */</span><span class="w"></span>
<span class="linenos">273</span><span class="p">}</span><span class="w"></span>
<span class="linenos">274</span>
<span class="linenos">275</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeInitializationFunction0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">276</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">277</span><span class="p">}</span><span class="w"></span>
<span class="linenos">278</span>
<span class="linenos">279</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeInitializationFunction1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">280</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">281</span><span class="p">}</span><span class="w"></span>
<span class="linenos">282</span>
<span class="linenos">283</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeInitializationFunctionExit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">284</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">285</span><span class="p">}</span><span class="w"></span>
<span class="linenos">286</span>
<span class="linenos">287</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeRunningFunction0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">288</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">289</span><span class="p">}</span><span class="w"></span>
<span class="linenos">290</span>
<span class="linenos">291</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeRunningFunction1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">292</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">293</span><span class="p">}</span><span class="w"></span>
<span class="linenos">294</span>
<span class="linenos">295</span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EG_SomeRunningFunction2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">296</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">297</span><span class="p">}</span><span class="w"></span>
<span class="linenos">298</span>
<span class="linenos">299</span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">300</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos">301</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">302</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_ENTRY</span><span class="p">:</span><span class="w"></span>
<span class="linenos">303</span><span class="w">            </span><span class="cm">/* Nothing to do, just transfer to next substate */</span><span class="w"></span>
<span class="linenos">304</span><span class="w">            </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_0</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">305</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">306</span>
<span class="linenos">307</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_INITIALIZATION_0</span><span class="p">:</span><span class="w"></span>
<span class="linenos">308</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeInitializationFunction0</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">309</span><span class="w">                </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_1</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">310</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">311</span><span class="w">                </span><span class="cm">/* Something went wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">312</span><span class="w">                </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">313</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">314</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">315</span>
<span class="linenos">316</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_INITIALIZATION_1</span><span class="p">:</span><span class="w"></span>
<span class="linenos">317</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeInitializationFunction1</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">318</span><span class="w">                </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_INITIALIZATION_EXIT</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">319</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">320</span><span class="w">                </span><span class="cm">/* Something went wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">321</span><span class="w">                </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">322</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">323</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">324</span>
<span class="linenos">325</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_INITIALIZATION_EXIT</span><span class="p">:</span><span class="w"></span>
<span class="linenos">326</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeInitializationFunctionExit</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">327</span><span class="w">                </span><span class="cm">/* Initialization was successful, so transition to running state */</span><span class="w"></span>
<span class="linenos">328</span><span class="w">                </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">;</span><span class="w"></span>
<span class="linenos">329</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">330</span><span class="w">                </span><span class="cm">/* Something went wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">331</span><span class="w">                </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">332</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">333</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">334</span>
<span class="linenos">335</span><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="linenos">336</span><span class="w">            </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"></span>
<span class="linenos">337</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="cm">/* LCOV_EXCL_LINE */</span><span class="w"></span>
<span class="linenos">338</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">339</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nextState</span><span class="p">;</span><span class="w"></span>
<span class="linenos">340</span><span class="p">}</span><span class="w"></span>
<span class="linenos">341</span>
<span class="linenos">342</span><span class="k">static</span><span class="w"> </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="nf">EG_ProcessRunningState</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">343</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">;</span><span class="w"> </span><span class="cm">/* default behavior: stay in state */</span><span class="w"></span>
<span class="linenos">344</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentSubstate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">345</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_ENTRY</span><span class="p">:</span><span class="w"></span>
<span class="linenos">346</span><span class="w">            </span><span class="cm">/* Nothing to do, just transfer to next substate */</span><span class="w"></span>
<span class="linenos">347</span><span class="w">            </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">348</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">349</span>
<span class="linenos">350</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">:</span><span class="w"></span>
<span class="linenos">351</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeRunningFunction0</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">352</span><span class="w">                </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_1</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">353</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">354</span><span class="w">                </span><span class="cm">/* Something went wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">355</span><span class="w">                </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">356</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">357</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">358</span>
<span class="linenos">359</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_RUNNING_1</span><span class="p">:</span><span class="w"></span>
<span class="linenos">360</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeRunningFunction1</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">361</span><span class="w">                </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_2</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">362</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">363</span><span class="w">                </span><span class="cm">/* Something went wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">364</span><span class="w">                </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">365</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">366</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">367</span>
<span class="linenos">368</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_SUBSTATE_RUNNING_2</span><span class="p">:</span><span class="w"></span>
<span class="linenos">369</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_SomeRunningFunction2</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">370</span><span class="w">                </span><span class="n">EG_SetSubstate</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_RUNNING_0</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">371</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">372</span><span class="w">                </span><span class="cm">/* Something went wrong, so transition to error state */</span><span class="w"></span>
<span class="linenos">373</span><span class="w">                </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">;</span><span class="w"></span>
<span class="linenos">374</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">375</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">376</span>
<span class="linenos">377</span><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="linenos">378</span><span class="w">            </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"></span>
<span class="linenos">379</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="cm">/* LCOV_EXCL_LINE */</span><span class="w"></span>
<span class="linenos">380</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">381</span>
<span class="linenos">382</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nextState</span><span class="p">;</span><span class="w"></span>
<span class="linenos">383</span><span class="p">}</span><span class="w"></span>
<span class="linenos">384</span>
<span class="linenos">385</span><span class="k">static</span><span class="w"> </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="nf">EG_RunStateMachine</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">386</span><span class="w">    </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="n">ranStateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos">387</span><span class="w">    </span><span class="n">EG_FSM_STATES_e</span><span class="w"> </span><span class="n">nextState</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">EG_FSM_STATE_DUMMY</span><span class="p">;</span><span class="w"></span>
<span class="linenos">388</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">currentState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">389</span><span class="w">        </span><span class="cm">/********************************************** STATE: HAS NEVER RUN */</span><span class="w"></span>
<span class="linenos">390</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_HAS_NEVER_RUN</span><span class="p">:</span><span class="w"></span>
<span class="linenos">391</span><span class="w">            </span><span class="cm">/* Nothing to do, just transfer */</span><span class="w"></span>
<span class="linenos">392</span><span class="w">            </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_UNINITIALIZED</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">393</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">394</span>
<span class="linenos">395</span><span class="w">        </span><span class="cm">/********************************************** STATE: UNINITIALIZED */</span><span class="w"></span>
<span class="linenos">396</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_UNINITIALIZED</span><span class="p">:</span><span class="w"></span>
<span class="linenos">397</span><span class="w">            </span><span class="cm">/* Nothing to do, just transfer */</span><span class="w"></span>
<span class="linenos">398</span><span class="w">            </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">399</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">400</span>
<span class="linenos">401</span><span class="w">        </span><span class="cm">/********************************************* STATE: INITIALIZATION */</span><span class="w"></span>
<span class="linenos">402</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_INITIALIZATION</span><span class="p">:</span><span class="w"></span>
<span class="linenos">403</span><span class="w">            </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_ProcessInitializationState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">404</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_INITIALIZATION</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">405</span><span class="w">                </span><span class="cm">/* staying in state, processed by state function */</span><span class="w"></span>
<span class="linenos">406</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">407</span><span class="w">                </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">408</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">409</span><span class="w">                </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">410</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">411</span><span class="w">                </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Something went wrong */</span><span class="w"></span>
<span class="linenos">412</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">413</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">414</span>
<span class="linenos">415</span><span class="w">        </span><span class="cm">/**************************************************** STATE: RUNNING */</span><span class="w"></span>
<span class="linenos">416</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_RUNNING</span><span class="p">:</span><span class="w"></span>
<span class="linenos">417</span><span class="w">            </span><span class="n">nextState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EG_ProcessRunningState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">418</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">419</span><span class="w">                </span><span class="cm">/* staying in state, processed by state function */</span><span class="w"></span>
<span class="linenos">420</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">421</span><span class="w">                </span><span class="n">EG_SetState</span><span class="p">(</span><span class="n">pEgState</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_STATE_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SUBSTATE_ENTRY</span><span class="p">,</span><span class="w"> </span><span class="n">EG_FSM_SHORT_TIME</span><span class="p">);</span><span class="w"></span>
<span class="linenos">422</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">423</span><span class="w">                </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Something went wrong */</span><span class="w"></span>
<span class="linenos">424</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">425</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">426</span>
<span class="linenos">427</span><span class="w">        </span><span class="cm">/****************************************************** STATE: ERROR */</span><span class="w"></span>
<span class="linenos">428</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">EG_FSM_STATE_ERROR</span><span class="p">:</span><span class="w"></span>
<span class="linenos">429</span><span class="w">            </span><span class="cm">/* implement error processing here or trap */</span><span class="w"></span>
<span class="linenos">430</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">431</span>
<span class="linenos">432</span><span class="w">        </span><span class="cm">/**************************************************** STATE: DEFAULT */</span><span class="w"></span>
<span class="linenos">433</span><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="linenos">434</span><span class="w">            </span><span class="cm">/* all cases must be processed, trap if unknown state arrives */</span><span class="w"></span>
<span class="linenos">435</span><span class="w">            </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">FAS_TRAP</span><span class="p">);</span><span class="w"></span>
<span class="linenos">436</span><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">437</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">438</span>
<span class="linenos">439</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ranStateMachine</span><span class="p">;</span><span class="w"></span>
<span class="linenos">440</span><span class="p">}</span><span class="w"></span>
<span class="linenos">441</span>
<span class="linenos">442</span><span class="cm">/*========== Extern Function Implementations ================================*/</span><span class="w"></span>
<span class="linenos">443</span><span class="k">extern</span><span class="w"> </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="nf">EG_Trigger</span><span class="p">(</span><span class="n">EG_STATE_s</span><span class="w"> </span><span class="o">*</span><span class="n">pEgState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">444</span><span class="w">    </span><span class="n">FAS_ASSERT</span><span class="p">(</span><span class="n">pEgState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL_PTR</span><span class="p">);</span><span class="w"></span>
<span class="linenos">445</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">earlyExit</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos">446</span><span class="w">    </span><span class="n">STD_RETURN_TYPE_e</span><span class="w"> </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos">447</span>
<span class="linenos">448</span><span class="w">    </span><span class="cm">/* Check multiple calls of function */</span><span class="w"></span>
<span class="linenos">449</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EG_MULTIPLE_CALLS_YES</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EG_CheckMultipleCalls</span><span class="p">(</span><span class="n">pEgState</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">450</span><span class="w">        </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_NOT_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos">451</span><span class="w">        </span><span class="n">earlyExit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">452</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">453</span>
<span class="linenos">454</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">earlyExit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">455</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">timer</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0u</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">456</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">--</span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0u</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">457</span><span class="w">                </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">triggerEntry</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="linenos">458</span><span class="w">                </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STD_OK</span><span class="p">;</span><span class="w"></span>
<span class="linenos">459</span><span class="w">                </span><span class="n">earlyExit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">460</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">461</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">462</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">463</span>
<span class="linenos">464</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">earlyExit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">465</span><span class="w">        </span><span class="n">EG_RunStateMachine</span><span class="p">(</span><span class="n">pEgState</span><span class="p">);</span><span class="w"></span>
<span class="linenos">466</span><span class="w">        </span><span class="n">pEgState</span><span class="o">-&gt;</span><span class="n">triggerEntry</span><span class="o">--</span><span class="p">;</span><span class="w"></span>
<span class="linenos">467</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">468</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">returnValue</span><span class="p">;</span><span class="w"></span>
<span class="linenos">469</span><span class="p">}</span><span class="w"></span>
<span class="linenos">470</span>
<span class="linenos">471</span><span class="cm">/*========== Externalized Static Function Implementations (Unit Test) =======*/</span><span class="w"></span>
<span class="linenos">472</span><span class="cp">#ifdef UNITY_UNIT_TEST</span>
<span class="linenos">473</span><span class="cp">#endif</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
<a href="https://github.com/foxBMS/foxbms-2">
    <img style="position: absolute; top: 0; right: 0; border: 0;"
        src="../../_static/forkme.png" alt="Fork me on GitHub">
</a>

          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../software/modules/driver/ts/adding-a-new-ts_how-to.html" class="btn btn-neutral float-left" title="8.2.2. How to Implement a New Temperature Sensor Driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../software/configuration/without-halcogen_how-to.html" class="btn btn-neutral float-right" title="8.2.4. How to Use Generated Sources from HALCoGen" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V. All rights reserved. See license section for further information.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>