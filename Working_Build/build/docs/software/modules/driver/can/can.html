<!-- https://stackoverflow.com/a/53329712 -->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.15. CAN &mdash; foxBMS 2 1.5.0 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="4.16. CRC" href="../crc/crc.html" />
    <link rel="prev" title="4.14. ADC" href="../adc/adc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> foxBMS 2
            <img src="../../../../_static/foxbms250px.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../general/releases.html">1. Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../general/changelog.html">2. Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../general/motivation.html">3. Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../general/safety/safety.html">4. Safety</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../general/license.html">5. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../general/team.html">6. Team</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/abbreviations-definitions.html">1. Abbreviations and Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/naming-conventions.html">2. Naming Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/bms-overview.html">3. The foxBMS 2 Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/use-case.html">4. Use Case</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting-started/getting-started.html">1. Getting Started with foxBMS 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting-started/repository-structure.html">2. Repository Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting-started/software-installation.html">3. Software Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting-started/workspace.html">4. Creating a Workspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting-started/first-steps-on-hardware.html">5. First Steps on Hardware</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">1. Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build/build.html">2. Building the Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/sw-overview.html">3. Software Structure Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../modules.html">4. Software Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../application/algorithm/algorithm.html">4.1. Algorithm Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../application/bal/bal.html">4.2. Balancing Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../application/bms/bms.html">4.3. BMS Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../application/plausibility/plausibility.html">4.4. Plausibility Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../application/redundancy/redundancy.html">4.5. Redundancy Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../application/soa/soa.html">4.6. SOA Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../engine/database/database.html">4.7. Database Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../engine/diag/diag.html">4.8. Diagnosis Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../engine/hwinfo/hwinfo.html">4.9. Hardware Info Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../engine/sys/sys.html">4.10. System Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../engine/sys_mon/sys_mon.html">4.11. System Monitoring Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../task/ftask/ftask.html">4.12. FTASK Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../task/os/os.html">4.13. OS Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../adc/adc.html">4.14. ADC</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.15. CAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crc/crc.html">4.16. CRC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contactor/contactor.html">4.17. Contactor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dma/dma.html">4.18. DMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../foxmath/foxmath.html">4.19. foxmath</a></li>
<li class="toctree-l2"><a class="reference internal" href="../foxmath/utils.html">4.20. utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fram/fram.html">4.21. FRAM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../htsen/htsen.html">4.22. Humidity/Temperature Sensor Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c/i2c.html">4.23. I2C Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../imd/imd.html">4.24. Insulation Measurement Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interlock/interlock.html">4.25. Interlock</a></li>
<li class="toctree-l2"><a class="reference internal" href="../io/io.html">4.26. IO Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../meas/meas.html">4.27. Measurement Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mcu/mcu.html">4.28. MCU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../afe/afe.html">4.29. Analog Front-End API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../afe/supported-afes.html">4.30. Supported Analog Front-Ends</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pex/pex.html">4.31. Port Expander Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pwm/pwm.html">4.32. PWM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rtc/rtc.html">4.33. RTC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sbc/sbc.html">4.34. SBC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi/spi.html">4.35. SPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sps/sps.html">4.36. SPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ts/ts.html">4.37. Temperature Sensor API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ts/ts-sensors.html">4.38. Supported Temperature Sensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../main/startup.html">4.39. Embedded Software Startup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../main/version.html">4.40. Version Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../main/fassert.html">4.41. FASSERT Module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../unit-tests/unit-tests.html">5. Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build-process/build-process.html">6. Build Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build-environment/build-environment.html">7. Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/how-to.html">8. How-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linker-script/linker-script.html">9. Linker Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/architecture.html">10. Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/overview.html">11. API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../hardware/hardware.html">1. Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hardware/design-resources.html">2. Design Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hardware/connectors.html">3. Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hardware/master.html">4. Master Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hardware/slaves.html">5. Slaves Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hardware/interfaces.html">6. Interfaces Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">System Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../system/system-introduction.html">1. System Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../system/system-voltage-and-current-monitoring.html">2. System Voltage And Current Monitoring</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/dbc.html">1. DBC File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/gui/gui.html">2. foxBMS 2 GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/waf-tools/waf-tools.html">3. Waf Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/debugger/debug-application.html">4. Debugging the Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/halcogen/halcogen.html">5. HALCoGen tool documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tools/static-analysis/axivion.html">6. Axivion Bauhaus Suite</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer-manual/preface.html">1. Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer-manual/style-guide/style-guide.html">2. Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer-manual/software-developer-manual.html">3. Software Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer-manual/hardware-developer-manual.html">4. Hardware Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer-manual/public-release-process.html">5. Public Release Process</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/acknowledgements.html">1. Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/indices-and-tables.html">2. Indices and Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/bibliography.html">3. Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">foxBMS 2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../modules.html"><span class="section-number">4. </span>Software Modules</a> &raquo;</li>
      <li><span class="section-number">4.15. </span>CAN</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/software/modules/driver/can/can.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <div class="section" id="can">
<span id="id1"></span><h1><span class="section-number">4.15. </span>CAN<a class="headerlink" href="#can" title="Permalink to this headline"></a></h1>
<div class="section" id="module-files">
<h2><span class="section-number">4.15.1. </span>Module Files<a class="headerlink" href="#module-files" title="Permalink to this headline"></a></h2>
<div class="section" id="driver">
<h3><span class="section-number">4.15.1.1. </span>Driver<a class="headerlink" href="#driver" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src/app/driver/can/can.c</span></code> (<a class="reference external" href="../../../../_static/doxygen/src/html/can_8c.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/src/html/can_8c_source.html">source</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/app/driver/can/can.h</span></code> (<a class="reference external" href="../../../../_static/doxygen/src/html/can_8h.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/src/html/can_8h_source.html">source</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/app/driver/can/cbs/can_helper.c</span></code> (<a class="reference external" href="../../../../_static/doxygen/src/html/can__helper_8c.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/src/html/can__helper_8c_source.html">source</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/app/driver/can/cbs/can_helper.h</span></code> (<a class="reference external" href="../../../../_static/doxygen/src/html/can__helper_8h.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/src/html/can__helper_8h_source.html">source</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/app/driver/can/cbs/can_cbs.h</span></code> (<a class="reference external" href="../../../../_static/doxygen/src/html/can__cbs_8h.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/src/html/can__cbs_8h_source.html">source</a>)</p></li>
</ul>
</div>
<div class="section" id="configuration">
<h3><span class="section-number">4.15.1.2. </span>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src/app/driver/config/can_cfg.c</span></code> (<a class="reference external" href="../../../../_static/doxygen/src/html/can__cfg_8c.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/src/html/can__cfg_8c_source.html">source</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/app/driver/config/can_cfg.h</span></code> (<a class="reference external" href="../../../../_static/doxygen/src/html/can__cfg_8h.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/src/html/can__cfg_8h_source.html">source</a>)</p></li>
</ul>
</div>
<div class="section" id="unit-test">
<h3><span class="section-number">4.15.1.3. </span>Unit Test<a class="headerlink" href="#unit-test" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tests/unit/app/driver/can/test_can.c</span></code> (<a class="reference external" href="../../../../_static/doxygen/tests/html/test__can_8c.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/tests/html/test__can_8c_source.html">source</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tests/unit/app/driver/config/test_can_cfg.c</span></code> (<a class="reference external" href="../../../../_static/doxygen/tests/html/test__can__cfg_8c.html">API</a>, <a class="reference external" href="../../../../_static/doxygen/tests/html/test__can__cfg_8c_source.html">source</a>)</p></li>
</ul>
</div>
</div>
<div class="section" id="description">
<h2><span class="section-number">4.15.2. </span>Description<a class="headerlink" href="#description" title="Permalink to this headline"></a></h2>
<p>In <code class="docutils literal notranslate"><span class="pre">can_cfg.c</span></code>, CAN messages are defined in two tables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">can_txMessages[]</span></code> for messages to be sent.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">can_rxMessages[]</span></code> for messages to be received.</p></li>
</ul>
<div class="section" id="messages-to-send">
<h3><span class="section-number">4.15.2.1. </span>Messages to send<a class="headerlink" href="#messages-to-send" title="Permalink to this headline"></a></h3>
<p>The sent message parameters are:</p>
<ul class="simple">
<li><p>CAN ID of message to be sent.</p></li>
<li><p>data length code, number of bytes to send. Default 8, maximum 8.</p></li>
<li><p>repetition time, period of transmission in ms.
Must be a multiple of 10.</p></li>
<li><p>repetition phase, delay for the first transmission.
Avoids sending all messages with same period at the same time.</p></li>
<li><p>byte order, endianness (big or little endian) of CAN data.</p></li>
<li><p>callback function, pointer to the function that is called when the message
has to be sent.</p></li>
<li><p>multiplexer, pointer to a number.
This is used to multiplex data in CAN messages.
A static variable must be defined to be used as multiplexer.</p></li>
</ul>
<p>The data of the CAN message is divided into signals.
Data for each signal is prepared within the callback function.
The developer must implement the signals as needed by the application.</p>
<p>Two helper functions are defined for this task,
<code class="docutils literal notranslate"><span class="pre">CAN_TxSetMessageDataWithSignalData()</span></code> and
<code class="docutils literal notranslate"><span class="pre">CAN_TxSetCanDataWithMessageData()</span></code>.
In the callback function, a <code class="docutils literal notranslate"><span class="pre">uint64_t</span> <span class="pre">variable</span></code> must be defined, which
represents the CAN message.
With the function <code class="docutils literal notranslate"><span class="pre">CAN_TxSetMessageDataWithSignalData()</span></code>, the signal data
can be stored in the message data. The parameters are</p>
<ul class="simple">
<li><p>pointer to 64-bit CAN message.</p></li>
<li><p>bit position in CAN message where the signal data must be stored.</p></li>
<li><p>length of the signal data in the CAN message.</p></li>
<li><p>signal data. Fox example, if data is a float, it must be cast
to an integer before being passed to the function.</p></li>
<li><p>endianness (big or little endian) of CAN data.</p></li>
</ul>
<p>Once the CAN message is ready, the function
<code class="docutils literal notranslate"><span class="pre">CAN_TxSetCanDataWithMessageData()</span></code> must be called.
It will store the CAN message in the variable used by the low-level driver for
the actual transmission.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">CAN_PeriodicTransmit()</span></code> is called every 10ms by the 10ms task.
It parses all the elements of <code class="docutils literal notranslate"><span class="pre">can_txMessages[]</span></code>.
If the time has been reached to send the messages, the corresponding callback
function is called.</p>
<p>The message is then sent with the function <code class="docutils literal notranslate"><span class="pre">CAN_DataSend()</span></code>.
The function <code class="docutils literal notranslate"><span class="pre">CAN_DataSend()</span></code> can also be used to send a CAN message directly
anywhere else in the code.</p>
</div>
<div class="section" id="messages-to-receive">
<h3><span class="section-number">4.15.2.2. </span>Messages to receive<a class="headerlink" href="#messages-to-receive" title="Permalink to this headline"></a></h3>
<p>The received message parameters are:</p>
<ul class="simple">
<li><p>CAN ID of message to be received.</p></li>
<li><p>data length code, number of bytes to receive. Default 8, maximum 8.</p></li>
<li><p>byte order, endianness (big or little endian) of CAN data.</p></li>
<li><p>callback function: pointer to the function that is called when the message
is received. The data of the CAN message is available within this
function.</p></li>
</ul>
<p>A receive queue called <code class="docutils literal notranslate"><span class="pre">ftsk_canRxQueue</span></code> is used as shown in
<a class="reference internal" href="#queue-can-receive-code-queue"><span class="std std-ref">Queue handle for CAN receive</span></a> and
<a class="reference internal" href="#queue-can-receive-code-vars"><span class="std std-ref">Supporting variables for the queue of the CAN receive module</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="queue-can-receive-code-queue">
<div class="code-block-caption"><span class="caption-number">Listing 4.6 </span><span class="caption-text">Queue handle for CAN receive</span><a class="headerlink" href="#queue-can-receive-code-queue" title="Permalink to this code"></a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">OS_QUEUE</span><span class="w"> </span><span class="n">ftsk_canRxQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL_PTR</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="queue-can-receive-code-vars">
<div class="code-block-caption"><span class="caption-number">Listing 4.7 </span><span class="caption-text">Supporting variables for the queue of the CAN receive module</span><a class="headerlink" href="#queue-can-receive-code-vars" title="Permalink to this code"></a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w">    </span><span class="cm">/* structure and array for static CAN RX queue */</span><span class="w"></span>
<span class="linenos">2</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ftsk_canRxQueueStorageArea</span><span class="p">[</span><span class="n">FTSK_CAN_RX_QUEUE_STORAGE_AREA</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="linenos">3</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">StaticQueue_t</span><span class="w"> </span><span class="n">ftsk_canRxQueueStructure</span><span class="w">                             </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>When CAN messages are received, the CAN interrupt callback calls
<code class="docutils literal notranslate"><span class="pre">CAN_RxInterrupt()</span></code>. The message received is sent to the queue.
The function <code class="docutils literal notranslate"><span class="pre">CAN_ReadRxBuffer()</span></code> is called every 1ms by the 1ms task.
For each element in the queue, it checks if the CAN message ID matches
an ID of the RX message list <code class="docutils literal notranslate"><span class="pre">can_rxMessages[]</span></code>. If this is the case,
the corresponding callback function is called.</p>
<p>In the callback function, a <code class="docutils literal notranslate"><span class="pre">uint64_t</span> <span class="pre">variable</span></code> must be defined, which
represents the CAN message. The helper function
<code class="docutils literal notranslate"><span class="pre">CAN_RxGetMessageDataFromCanData()</span></code> <strong>MUST</strong> be called at the beginning.
It copies the CAN data retrieved by the low level driver into the message
variable. If necessary, the other helper function
<code class="docutils literal notranslate"><span class="pre">CAN_RxGetSignalDataFromMessageData()</span></code> can be used to retrieve signal data
easily from the message. The parameters are</p>
<ul class="simple">
<li><p>64-bit CAN message.</p></li>
<li><p>bit position in CAN message where the signal data
must be stored.</p></li>
<li><p>length of the signal data in the CAN message.</p></li>
<li><p>pointer to signal data.</p></li>
<li><p>endianness (big or little endian) of CAN data.</p></li>
</ul>
<p>The signal data is then available in the variable pointed to by the signal
data pointer.</p>
<p>A receive queue was used because usually the developer needs to access the
database in the callback of the receive function, but this must not be done in
an interrupt routine.
With the current implementation, the receive interrupt routine sends the
received data to the queue.
The <code class="docutils literal notranslate"><span class="pre">CAN_ReadRxBuffer()</span></code> function retrieves the messages from the queue and
calls the callbacks outside of the interrupt routine.</p>
</div>
<div class="section" id="configuration-in-halcogen">
<h3><span class="section-number">4.15.2.3. </span>Configuration in HALCoGen<a class="headerlink" href="#configuration-in-halcogen" title="Permalink to this headline"></a></h3>
<p>64 messages boxes are available for each CAN interface. 32 of them are
configured as transmit message boxes, the other half as receive message boxes
(with HALCoGen), so the macro <code class="docutils literal notranslate"><span class="pre">CAN_NR_OF_TX_MESSAGE_BOX</span></code> is set to 32.
It must be adapted if the number of transmit message boxes is changed.</p>
<p>Unfortunately, using HALCoGen, only the complete CAN interface and not the
individual message boxes can be configured if standard or extended identifiers
shall be used.</p>
<p>For this reason, four receive mailboxes (mailboxes 61-64) are hard-coded during
the initialization and overwrite the respective HALCoGen configuration for
these mailboxes.
The mailboxes are configured to receive all CAN messages
with an extended 29-bit identifier. This configuration is done in function
<code class="docutils literal notranslate"><span class="pre">CAN_ConfigureRxMailboxesForExtendedIdentifiers()</span></code></p>
</div>
<div class="section" id="configuration-errors-in-halcogen">
<h3><span class="section-number">4.15.2.4. </span>Configuration errors in HALCoGen<a class="headerlink" href="#configuration-errors-in-halcogen" title="Permalink to this headline"></a></h3>
<p>When using the CAN interface <code class="docutils literal notranslate"><span class="pre">CAN4</span></code>, special care has to be taken because of
a bug in HALCoGen. For more information, refer to
<a class="reference internal" href="../../../../tools/halcogen/halcogen.html#halcogen-tool-documentation"><span class="std std-ref">HALCoGen tool documentation</span></a>.</p>
<p>Additionally, there is a bug in HALCoGen regarding the CAN1 mailbox 42 as
described in <a class="reference internal" href="../../../../tools/halcogen/halcogen.html#halcogen-tool-documentation"><span class="std std-ref">HALCoGen tool documentation</span></a>.
The missing configuration for this mailbox is also done in function
<code class="docutils literal notranslate"><span class="pre">CAN_ConfigureRxMailboxesForExtendedIdentifiers()</span></code>.
Mailbox 42 is configured
to receive all CAN messages with a standard 11-bit identifier.</p>
</div>
<div class="section" id="callback-definition">
<h3><span class="section-number">4.15.2.5. </span>Callback definition<a class="headerlink" href="#callback-definition" title="Permalink to this headline"></a></h3>
<p>If a new file is needed for a new callback, it must be added in the
directory <code class="docutils literal notranslate"><span class="pre">./src/app/driver/can/cbs</span></code>. The corresponding header is the file
<code class="docutils literal notranslate"><span class="pre">can_cbs.h</span></code> in the same directory. The new callback file must also be added
to the <code class="docutils literal notranslate"><span class="pre">wscript</span></code> file in <code class="docutils literal notranslate"><span class="pre">./src/app/driver</span></code>. For instance, if the file
<code class="docutils literal notranslate"><span class="pre">can_my_callback.c</span></code> is added, the line</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;can&quot;</span><span class="p">,</span> <span class="s2">&quot;cbs&quot;</span><span class="p">,</span> <span class="s2">&quot;can_my_callback.c&quot;</span><span class="p">),</span>
</pre></div>
</div>
<p>must be added.</p>
</div>
</div>
</div>


           </div>
          </div>
<a href="https://github.com/foxBMS/foxbms-2">
    <img style="position: absolute; top: 0; right: 0; border: 0;"
        src="../../../../_static/forkme.png" alt="Fork me on GitHub">
</a>

          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../adc/adc.html" class="btn btn-neutral float-left" title="4.14. ADC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../crc/crc.html" class="btn btn-neutral float-right" title="4.16. CRC" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010 - 2023, Fraunhofer-Gesellschaft zur Foerderung der angewandten Forschung e.V. All rights reserved. See license section for further information.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>